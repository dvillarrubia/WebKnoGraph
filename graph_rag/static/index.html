<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebKnoGraph - Graph RAG Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #333333;
            --accent-color: #2563eb;
            --bg-dark: #ffffff;
            --bg-card: #f8f8f8;
            --bg-card-hover: #eeeeee;
            --text-primary: #000000;
            --text-secondary: #555555;
            --border-color: #cccccc;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
        }

        /* Tema Oscuro */
        [data-theme="dark"] {
            --primary-color: #ffffff;
            --secondary-color: #e5e5e5;
            --accent-color: #3b82f6;
            --bg-dark: #0f0f0f;
            --bg-card: #1a1a1a;
            --bg-card-hover: #262626;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --border-color: #333333;
            --success-color: #22c55e;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            z-index: 1000;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .sidebar-brand-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #ffffff;
        }

        .sidebar-brand-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: var(--bg-dark);
            border: 1px solid var(--primary-color);
        }

        .nav-item i {
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 2rem;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            color: var(--text-primary);
            gap: 0.5rem;
        }

        /* Chat Section */
        .chat-container {
            height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.user {
            background: var(--primary-color);
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* RAG Response Markdown Styling */
        .rag-markdown {
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .rag-markdown h1, .rag-markdown h2, .rag-markdown h3, .rag-markdown h4 {
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .rag-markdown h1:first-child, .rag-markdown h2:first-child, .rag-markdown h3:first-child {
            margin-top: 0;
        }

        .rag-markdown h1 { font-size: 1.3rem; }
        .rag-markdown h2 { font-size: 1.15rem; }
        .rag-markdown h3 { font-size: 1.05rem; }
        .rag-markdown h4 { font-size: 1rem; border-bottom: none; }

        .rag-markdown p {
            margin-bottom: 0.85rem;
        }

        .rag-markdown p:last-child {
            margin-bottom: 0;
        }

        .rag-markdown ul, .rag-markdown ol {
            margin-left: 1.25rem;
            margin-bottom: 0.85rem;
            padding-left: 0.5rem;
        }

        .rag-markdown li {
            margin-bottom: 0.35rem;
        }

        .rag-markdown li:last-child {
            margin-bottom: 0;
        }

        .rag-markdown a {
            color: #60a5fa;
            text-decoration: none;
            border-bottom: 1px dotted #60a5fa;
        }

        .rag-markdown a:hover {
            color: #93c5fd;
            border-bottom-style: solid;
        }

        .rag-markdown strong, .rag-markdown b {
            font-weight: 700;
            color: var(--text-primary);
        }

        .rag-markdown em, .rag-markdown i {
            font-style: italic;
        }

        .rag-markdown code {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.85em;
        }

        .rag-markdown pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .rag-markdown pre code {
            background: none;
            padding: 0;
        }

        .rag-markdown blockquote {
            border-left: 3px solid var(--primary-color);
            margin: 1rem 0;
            padding-left: 1rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .rag-markdown hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 1.5rem 0;
        }

        .rag-markdown table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .rag-markdown th, .rag-markdown td {
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .rag-markdown th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .rag-stats {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Search Mode Selector */
        .search-mode-selector {
            display: flex;
            gap: 0.5rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #ffffff;
        }

        .mode-btn i {
            font-size: 1rem;
        }

        /* Feature Toggles */
        .rag-features {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .feature-toggle {
            display: flex;
            align-items: center;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            margin: 0;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-switch {
            width: 36px;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle-label input:checked + .toggle-switch {
            background: #34d399;
        }

        .toggle-label input:checked + .toggle-switch::after {
            transform: translateX(16px);
        }

        .toggle-text {
            color: var(--text-primary);
        }

        .toggle-text small {
            opacity: 0.6;
        }

        .advanced-toggle a {
            text-decoration: none;
        }

        .advanced-toggle a:hover {
            color: var(--text-primary) !important;
        }

        /* Search Toolbar */
        .search-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .search-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Compare Modal Styles */
        #compareModal .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        #compareModal .modal-header {
            border-bottom-color: var(--border-color);
        }

        #compareModal .form-control {
            background: var(--bg-main);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        #compareModal .form-control:focus {
            background: var(--bg-main);
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .compare-mode-selector {
            display: flex;
            gap: 0.5rem;
        }

        .compare-mode-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .compare-mode-btn:hover {
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .compare-mode-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #ffffff;
        }

        .compare-results {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            max-height: 450px;
            overflow-y: auto;
        }

        .compare-result-item {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            background: var(--bg-card);
        }

        .compare-result-item:last-child {
            margin-bottom: 0;
        }

        .compare-result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .compare-result-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .compare-result-score {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .compare-result-url {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .compare-result-snippet {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            max-height: 80px;
            overflow: hidden;
        }

        .compare-result-snippet mark {
            background: rgba(251, 191, 36, 0.3);
            color: var(--text-primary);
            padding: 0 2px;
            border-radius: 2px;
        }

        .message-sources {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .message-sources strong {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-sources .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .message.user .message-sources {
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .source-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: rgba(96, 165, 250, 0.1);
            padding: 0.35rem 0.65rem;
            border-radius: 4px;
            margin: 0.25rem 0.25rem 0.25rem 0;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
        }

        .source-link:hover {
            background: var(--primary-color);
            color: #ffffff;
        }

        .chat-input-container {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        /* Search Section */
        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-filters {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover, .filter-chip.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #ffffff;
        }

        .filter-chip small {
            opacity: 0.7;
            font-size: 0.75em;
        }

        .filter-chip.active small {
            opacity: 0.9;
        }

        .filter-chip-loading {
            padding: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-results {
            margin-top: 1.5rem;
        }

        .result-item {
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .result-item:hover {
            border-left: 3px solid var(--primary-color);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            cursor: pointer;
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .result-url {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .result-snippet {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .result-heading {
            font-size: 0.85rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .result-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .result-score,
        .result-chunk-index,
        .result-pagerank {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-card-hover);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .result-score {
            background: rgba(52, 211, 153, 0.1);
            border-color: rgba(52, 211, 153, 0.3);
            color: #34d399;
        }

        .result-chunk-index {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.3);
            color: #60a5fa;
        }

        .result-pagerank {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .result-expand-btn {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            white-space: nowrap;
        }

        .result-expand-btn:hover {
            background: #333333;
        }

        .result-content {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .result-content.expanded {
            display: block;
        }

        .result-markdown {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            max-height: 500px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.7;
            font-family: inherit;
            color: var(--text-primary);
        }

        .result-markdown h1, .result-markdown h2, .result-markdown h3, .result-markdown h4 {
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .result-markdown h1:first-child, .result-markdown h2:first-child, .result-markdown h3:first-child {
            margin-top: 0;
        }

        .result-markdown h1 { font-size: 1.4rem; }
        .result-markdown h2 { font-size: 1.2rem; }
        .result-markdown h3 { font-size: 1.1rem; }
        .result-markdown h4 { font-size: 1rem; border-bottom: none; }

        .result-markdown p {
            margin-bottom: 1rem;
        }

        .result-markdown ul, .result-markdown ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }

        .result-markdown li {
            margin-bottom: 0.4rem;
        }

        .result-markdown a {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .result-markdown a:hover {
            color: #333333;
        }

        .result-markdown strong, .result-markdown b {
            font-weight: 700;
        }

        .result-markdown em, .result-markdown i {
            font-style: italic;
        }

        .result-markdown code {
            background: var(--bg-card-hover);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85em;
        }

        .result-markdown pre {
            background: var(--bg-card-hover);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .result-markdown pre code {
            background: none;
            padding: 0;
        }

        .result-markdown blockquote {
            border-left: 3px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .result-markdown hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 1.5rem 0;
        }

        .result-markdown table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .result-markdown th, .result-markdown td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
        }

        .result-markdown th {
            background: var(--bg-card-hover);
            font-weight: 600;
        }

        .result-markdown img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        /* Preview Modal Styles */
        .preview-content {
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .preview-content h1, .preview-content h2, .preview-content h3, .preview-content h4 {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .preview-content h1:first-child, .preview-content h2:first-child, .preview-content h3:first-child {
            margin-top: 0;
        }

        .preview-content h1 { font-size: 1.75rem; }
        .preview-content h2 { font-size: 1.4rem; }
        .preview-content h3 { font-size: 1.2rem; }
        .preview-content h4 { font-size: 1.1rem; border-bottom: none; }

        .preview-content p {
            margin-bottom: 1rem;
        }

        .preview-content ul, .preview-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }

        .preview-content li {
            margin-bottom: 0.5rem;
        }

        .preview-content a {
            color: var(--accent-color);
            text-decoration: underline;
        }

        .preview-content strong, .preview-content b {
            font-weight: 700;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .preview-content blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .preview-content code {
            background: var(--bg-card);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85em;
        }

        .preview-content pre {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .preview-content th, .preview-content td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
        }

        .preview-content th {
            background: var(--bg-card);
            font-weight: 600;
        }

        /* Preview Modal - Force Fullscreen */
        #previewModal.modal {
            padding: 0 !important;
        }

        #previewModal .modal-dialog {
            width: 100vw !important;
            max-width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
        }

        #previewModal .modal-content {
            background: #ffffff !important;
            color: #1a1a2e;
            height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
        }

        #previewModal .modal-header {
            background: #f8f9fa !important;
            border-bottom: 1px solid #dee2e6 !important;
            padding: 1rem 2rem;
            flex-shrink: 0;
        }

        #previewModal .modal-body {
            background: #ffffff !important;
            padding: 2rem 4rem;
            overflow-y: auto;
            flex: 1;
        }

        #previewModal .modal-footer {
            background: #f8f9fa !important;
            border-top: 1px solid #dee2e6 !important;
            flex-shrink: 0;
        }

        #previewModal .preview-content {
            max-width: 1000px;
            margin: 0 auto;
            font-size: 1.1rem;
            line-height: 1.9;
            color: #1a1a2e !important;
            background: #ffffff !important;
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
        }

        #previewModal .preview-content h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        #previewModal .preview-content h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        #previewModal .preview-content h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        #previewModal .preview-content p {
            margin-bottom: 1rem;
        }

        #previewModal .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
        }

        #previewModal .preview-content ul,
        #previewModal .preview-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        #previewModal .preview-content li {
            margin-bottom: 0.5rem;
        }

        /* Graph Section */
        .graph-container {
            height: 500px;
            background: var(--bg-dark);
            border-radius: 8px;
            position: relative;
        }

        .graph-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .graph-control-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .graph-control-btn:hover {
            background: var(--bg-card-hover);
        }

        .node-info {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Crawler Section */
        .crawl-form {
            display: grid;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .crawl-progress {
            margin-top: 1.5rem;
        }

        .progress-bar-container {
            background: var(--bg-dark);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .crawl-log {
            margin-top: 1.5rem;
            background: #0d1117;
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.8rem;
            border: 1px solid #30363d;
        }

        .log-entry {
            padding: 0.35rem 0.5rem;
            border-radius: 3px;
            margin-bottom: 2px;
            color: #c9d1d9;
            line-height: 1.4;
        }

        .log-entry:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Log colors with good contrast on dark bg */
        .log-entry.text-success { color: #3fb950 !important; }
        .log-entry.text-danger { color: #f85149 !important; font-weight: 600; }
        .log-entry.text-warning { color: #d29922 !important; }
        .log-entry.text-info { color: #58a6ff !important; }
        .log-entry.text-muted { color: #8b949e !important; }

        .log-entry.success { color: #3fb950; font-weight: 500; }
        .log-entry.warning { color: #d29922; }
        .log-entry.error { color: #f85149; font-weight: 600; }

        /* Phase Indicator Styles */
        .phase-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .phase-icon i {
            font-size: 1rem;
        }

        .phase-connector {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            margin: 0 0.5rem;
            margin-top: -20px;
        }

        .phase-active .phase-icon {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .phase-complete .phase-icon {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .phase-complete + .phase-connector {
            background: var(--success-color);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(37, 99, 235, 0); }
        }

        /* Stats card hover effect */
        #statLinksContainer:hover {
            background: var(--bg-card-hover);
            transition: background 0.2s;
        }

        /* Admin Section */
        .clients-table {
            width: 100%;
        }

        .clients-table th,
        .clients-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .clients-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .client-domain {
            color: var(--primary-color);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: var(--primary-color);
            color: #ffffff;
        }

        .badge-warning {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--bg-dark);
            border: 1px solid var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: var(--bg-dark);
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn-danger {
            background: #ffffff;
            color: #333333;
            border: 2px solid #333333;
        }

        .btn-danger:hover {
            background: #333333;
            color: #ffffff;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Section visibility */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stats-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .stats-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .stats-card-icon.primary { background: var(--primary-color); color: #ffffff; }
        .stats-card-icon.success { background: #333333; color: #ffffff; }
        .stats-card-icon.warning { background: #555555; color: #ffffff; }
        .stats-card-icon.danger { background: #777777; color: #ffffff; }

        .stats-card-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stats-card-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.modal-large {
            max-width: 90vw;
            width: 90vw;
            height: 80vh;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-large .modal-header {
            flex-shrink: 0;
        }

        .modal-large .modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            min-height: 0;
        }

        #graphContainer {
            width: 100%;
            height: calc(80vh - 70px);
            min-height: 500px;
            background: #1a1a2e;
        }

        /* vis.js canvas styles */
        #graphContainer canvas {
            width: 100% !important;
            height: 100% !important;
        }

        #graphContainer .vis-network {
            width: 100% !important;
            height: 100% !important;
            position: relative !important;
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .progress-stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--bg-card-hover);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .toast.success { border-left: 3px solid var(--primary-color); }
        .toast.error { border-left: 3px solid #333333; }
        .toast.warning { border-left: 3px solid #555555; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            z-index: 2000;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-color);
            color: var(--bg-dark);
        }

        /* Custom Range Slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            outline: none;
            transition: all var(--transition-fast);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: var(--shadow-md);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
        }

        /* Custom Checkbox */
        .form-check-input {
            width: 18px;
            height: 18px;
            background-color: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
            background-size: 12px;
            background-position: center;
            background-repeat: no-repeat;
        }

        [data-theme="dark"] .form-check-input:checked {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        /* Loading States */
        .loading-text {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-text::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Enhanced Cards */
        .card {
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* Enhanced Buttons */
        .btn {
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Nav Items Enhanced */
        .nav-item {
            transition: all var(--transition-normal);
        }

        .nav-item:hover {
            transform: translateX(4px);
        }

        .nav-item.active {
            transform: translateX(0);
        }

        /* Smooth Section Transitions */
        .section {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards Enhanced */
        .stats-card {
            transition: all var(--transition-normal);
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        /* Input Focus States */
        .form-control:focus,
        .chat-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .chat-input:focus {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }

        /* Graph Container Placeholder */
        .graph-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
        }

        .graph-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Result Items Enhanced */
        .result-item {
            transition: all var(--transition-normal);
        }

        .result-item:hover {
            transform: translateX(4px);
        }

        /* Filter Chips Enhanced */
        .filter-chip {
            transition: all var(--transition-fast);
        }

        .filter-chip:hover {
            transform: scale(1.05);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* Pulse Animation for Active States */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .crawling .progress-bar {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
        <i class="bi bi-moon-fill" id="themeIcon"></i>
    </button>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon">
                <i class="bi bi-diagram-3"></i>
            </div>
            <span class="sidebar-brand-text">WebKnoGraph</span>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a class="nav-item active" data-section="chat">
                    <i class="bi bi-chat-dots"></i>
                    <span>Chat RAG</span>
                </a>
                <a class="nav-item" data-section="search">
                    <i class="bi bi-search"></i>
                    <span>Buscar</span>
                </a>
                <a class="nav-item" data-section="graph">
                    <i class="bi bi-share"></i>
                    <span>Explorador de Grafo</span>
                </a>
                <a class="nav-item" data-section="interlinking">
                    <i class="bi bi-link-45deg"></i>
                    <span>Interlinking</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Pipeline</div>
                <a class="nav-item" data-section="crawler">
                    <i class="bi bi-globe"></i>
                    <span>1. Crawler</span>
                </a>
                <a class="nav-item" data-section="cleaner">
                    <i class="bi bi-magic"></i>
                    <span>2. Limpieza</span>
                </a>
                <a class="nav-item" data-section="ingest">
                    <i class="bi bi-database-add"></i>
                    <span>3. Ingestin</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Administracin</div>
                <a class="nav-item" data-section="clients">
                    <i class="bi bi-building"></i>
                    <span>Clientes</span>
                </a>
                <a class="nav-item" data-section="settings">
                    <i class="bi bi-gear"></i>
                    <span>Configuracin</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Chat RAG Section -->
        <section id="chat" class="section active">
            <div class="page-header">
                <h1 class="page-title">Chat RAG</h1>
                <p class="page-subtitle">Consulta tu base de conocimiento con IA</p>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message assistant">
                                <p>Hola, soy tu asistente RAG. Puedo responder preguntas basndome en el contenido indexado de tu sitio web. En qu puedo ayudarte?</p>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <div class="chat-input-wrapper">
                                <input type="text" class="chat-input" id="chatInput" placeholder="Escribe tu pregunta..." />
                                <button class="btn btn-primary" id="sendMessage">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-sliders"></i> Opciones</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label>Cliente</label>
                                <select class="form-control" id="chatClientSelect">
                                    <option value="">Cargando clientes...</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label>Modo de bsqueda</label>
                                <div class="search-mode-selector">
                                    <button type="button" class="mode-btn" data-mode="fast" title="Solo vectores, sin grafo">
                                        <i class="bi bi-lightning"></i> Rpido
                                    </button>
                                    <button type="button" class="mode-btn active" data-mode="balanced" title="Vectores + Grafo + Reranking">
                                        <i class="bi bi-stars"></i> Normal
                                    </button>
                                    <button type="button" class="mode-btn" data-mode="exhaustive" title="Mxima cobertura">
                                        <i class="bi bi-search-heart"></i> Exhaustivo
                                    </button>
                                </div>
                            </div>

                            <div class="rag-features mb-3">
                                <div class="feature-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="useReranking" checked>
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Reranking <small class="text-muted">(BGE-M3)</small></span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="useGraph" checked>
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Expansin por grafo</span>
                                    </label>
                                </div>
                                <div class="feature-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="useCommunities" checked>
                                        <span class="toggle-switch"></span>
                                        <span class="toggle-text">Comunidades temticas</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label>Chunks en contexto: <span id="maxChunksValue">15</span></label>
                                <input type="range" class="form-range" id="maxChunks" min="5" max="30" value="15">
                            </div>

                            <div class="advanced-toggle mb-2">
                                <a href="#" id="showAdvanced" class="text-muted small">
                                    <i class="bi bi-gear"></i> Opciones avanzadas
                                </a>
                            </div>
                            <div id="advancedOptions" style="display: none;">
                                <div class="form-group mb-2">
                                    <label class="small">Similitud mnima: <span id="minSimValue">0.3</span></label>
                                    <input type="range" class="form-range" id="minSim" min="0.1" max="0.8" step="0.1" value="0.3">
                                </div>
                                <div class="form-group">
                                    <label class="small">Saltos de grafo: <span id="graphHopsValue">2</span></label>
                                    <input type="range" class="form-range" id="graphHops" min="1" max="3" value="2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Search Section -->
        <section id="search" class="section">
            <div class="page-header">
                <h1 class="page-title">Buscar</h1>
                <p class="page-subtitle">Bsqueda vectorial en el contenido indexado</p>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="text" id="searchInput" placeholder="Buscar en el contenido..." />
                            </div>
                            <div class="search-toolbar">
                                <div class="search-filters" id="searchFilters">
                                    <span class="filter-chip active" data-filter="all">Todos</span>
                                    <!-- Dynamic filters loaded from API based on client's URL patterns -->
                                    <span class="filter-chip-loading text-muted small" id="filtersLoading">
                                        <span class="spinner-border spinner-border-sm"></span> Cargando filtros...
                                    </span>
                                </div>
                                <div class="search-actions">
                                    <button class="btn btn-outline-secondary btn-sm" id="refreshFilters" title="Recargar filtros del cliente">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" id="openCompareModal" title="Comparar texto con chunks">
                                        <i class="bi bi-file-diff"></i> Comparar
                                    </button>
                                </div>
                            </div>
                            <div class="search-results" id="searchResults">
                                <p class="text-muted text-center mt-4">Escribe algo para buscar...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-sliders"></i> Opciones de bsqueda</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label>Cliente</label>
                                <select class="form-control" id="searchClientSelect">
                                    <option value="">Cargando clientes...</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label>Resultados: <span id="searchTopKValue">15</span></label>
                                <input type="range" class="form-range" id="searchTopK" min="5" max="50" value="15">
                            </div>
                            <div class="form-group mb-3">
                                <label>Similitud mnima: <span id="searchMinSimValue">0.2</span></label>
                                <input type="range" class="form-range" id="searchMinSim" min="0.1" max="0.6" step="0.05" value="0.2">
                            </div>
                            <div class="form-group mb-3">
                                <label>Filtro URL <small class="text-muted">(opcional)</small></label>
                                <input type="text" class="form-control form-control-sm" id="searchUrlFilter" placeholder="ej: /blog/, /fp-, cursos">
                            </div>
                            <div class="search-stats mt-3" id="searchStats" style="display:none;">
                                <small class="text-muted">
                                    <span id="searchResultsCount">0</span> resultados en <span id="searchTime">0</span>ms
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Text Compare Modal -->
        <div class="modal fade" id="compareModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-file-diff"></i> Comparar Texto con Contenido Indexado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label"><strong>Texto a comparar</strong></label>
                                    <textarea class="form-control" id="compareText" rows="12" placeholder="Pega aqu el texto que quieres comparar con el contenido indexado..."></textarea>
                                    <div class="mt-2">
                                        <small class="text-muted"><span id="compareCharCount">0</span> caracteres</small>
                                    </div>
                                </div>
                                <div class="form-group mt-3">
                                    <label class="form-label">Tipo de comparacin</label>
                                    <div class="compare-mode-selector">
                                        <button type="button" class="compare-mode-btn active" data-mode="chunks">
                                            <i class="bi bi-layers"></i> vs Chunks
                                        </button>
                                        <button type="button" class="compare-mode-btn" data-mode="pages">
                                            <i class="bi bi-file-text"></i> vs Pginas
                                        </button>
                                    </div>
                                </div>
                                <button class="btn btn-primary w-100 mt-3" id="runCompare">
                                    <i class="bi bi-search"></i> Buscar similares
                                </button>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>Resultados ms similares</strong></label>
                                <div class="compare-results" id="compareResults">
                                    <p class="text-muted text-center mt-4">Los resultados aparecern aqu...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graph Explorer Section -->
        <section id="graph" class="section">
            <div class="page-header">
                <h1 class="page-title">Explorador de Grafo</h1>
                <p class="page-subtitle">Visualiza las conexiones entre pginas</p>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-diagram-3"></i> Grafo de Enlaces</h5>
                        </div>
                        <div class="card-body">
                            <div class="graph-container" id="graphContainer">
                                <div class="graph-controls">
                                    <button class="graph-control-btn" id="zoomIn"><i class="bi bi-zoom-in"></i></button>
                                    <button class="graph-control-btn" id="zoomOut"><i class="bi bi-zoom-out"></i></button>
                                    <button class="graph-control-btn" id="resetView"><i class="bi bi-arrows-fullscreen"></i></button>
                                </div>
                                <div id="graphViz" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-search"></i> Buscar Nodo</h5>
                        </div>
                        <div class="card-body">
                            <input type="text" class="form-control" id="nodeSearch" placeholder="URL o ttulo..." />
                            <button class="btn btn-primary btn-sm mt-2 w-100" id="findNode">Buscar</button>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-signpost-split"></i> Encontrar Camino</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-2">
                                <input type="text" class="form-control" id="pathFrom" placeholder="URL origen..." />
                            </div>
                            <div class="form-group mb-2">
                                <input type="text" class="form-control" id="pathTo" placeholder="URL destino..." />
                            </div>
                            <button class="btn btn-primary btn-sm w-100" id="findPath">Encontrar Camino</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-info-circle"></i> Informacin del Nodo</h5>
                        </div>
                        <div class="card-body" id="nodeInfo">
                            <p class="text-muted">Selecciona un nodo para ver sus detalles</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interlinking Section -->
        <section id="interlinking" class="section">
            <div class="page-header">
                <h1 class="page-title">Interlinking</h1>
                <p class="page-subtitle">Sugiere enlaces internos basados en similitud semntica</p>
            </div>

            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-gear"></i> Configuracin</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label>Cliente</label>
                                <select class="form-control" id="interlinkingClientSelect">
                                    <option value="">Cargando clientes...</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label>URL de la pgina</label>
                                <input type="text" class="form-control" id="interlinkingUrl" placeholder="https://ejemplo.com/pagina" list="pagesList" />
                                <datalist id="pagesList"></datalist>
                            </div>
                            <div class="form-group mb-3">
                                <label>Similitud Mnima: <span id="interlinkingSimValue">0.5</span></label>
                                <input type="range" class="form-range" id="interlinkingSim" min="0.3" max="0.9" step="0.05" value="0.5">
                            </div>
                            <div class="form-group mb-3">
                                <label>Mximo de sugerencias</label>
                                <input type="number" class="form-control" id="interlinkingLimit" value="10" min="1" max="50" />
                            </div>
                            <button class="btn btn-primary w-100" id="getInterlinkingSuggestions">
                                <i class="bi bi-lightbulb"></i> Obtener Sugerencias
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-info-circle"></i> Pgina Actual</h5>
                        </div>
                        <div class="card-body" id="interlinkingPageInfo">
                            <p class="text-muted">Selecciona una pgina para ver informacin</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-lightbulb"></i> Sugerencias de Enlaces</h5>
                        </div>
                        <div class="card-body">
                            <div id="interlinkingSuggestions">
                                <p class="text-muted text-center">Ingresa una URL y haz clic en "Obtener Sugerencias"</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-arrow-left-right"></i> Enlaces Existentes</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-box-arrow-in-right"></i> Entrantes (Backlinks)</h6>
                                    <div id="interlinkingBacklinks">
                                        <p class="text-muted">Sin datos</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-box-arrow-right"></i> Salientes</h6>
                                    <div id="interlinkingOutlinks">
                                        <p class="text-muted">Sin datos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Crawler Section -->
        <section id="crawler" class="section">
            <div class="page-header">
                <h1 class="page-title">Crawler</h1>
                <p class="page-subtitle">Rastrea sitios web y extrae contenido</p>
            </div>

            <!-- Formulario Principal Simplificado -->
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Fila principal: URL + Botn -->
                    <div class="row align-items-end mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">
                                URL de Inicio
                                <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="URL base del sitio a crawlear. El crawler extraer todas las pginas del mismo dominio."></i>
                            </label>
                            <input type="url" class="form-control form-control-lg" id="crawlUrl" placeholder="https://ejemplo.com" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">
                                Mx. Pginas
                                <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Lmite de pginas a crawlear. Usa 0 para ilimitado. Recomendado: empezar con 100-500 para probar."></i>
                            </label>
                            <input type="number" class="form-control" id="crawlMaxPages" value="500" min="0" max="50000" />
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary btn-lg w-100" id="startCrawl">
                                <i class="bi bi-play-fill"></i> Iniciar
                            </button>
                        </div>
                    </div>

                    <!-- Opciones Rpidas -->
                    <div class="d-flex flex-wrap gap-4 mb-2">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="useSitemap" checked>
                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Descarga el sitemap.xml del sitio para descubrir URLs ms rpido. Recomendado activarlo.">
                                <i class="bi bi-diagram-3"></i> Usar Sitemap
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="contentFilter" checked>
                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Filtra contenido irrelevante usando algoritmo BM25. Mejora la calidad del contenido extrado.">
                                <i class="bi bi-funnel"></i> Filtrar BM25
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="respectRobots" checked>
                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Respeta las reglas del archivo robots.txt del sitio. Recomendado para cumplir con las polticas del sitio.">
                                <i class="bi bi-shield-check"></i> Respetar robots.txt
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="skipNoindex" checked>
                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Salta pginas marcadas con meta noindex. Estas pginas no se indexan en buscadores y suelen tener contenido no relevante.">
                                <i class="bi bi-eye-slash"></i> Saltar noindex
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="resumeCrawl">
                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Si ya existe un crawl previo de este dominio, contina desde donde se qued sin re-crawlear pginas ya visitadas.">
                                <i class="bi bi-arrow-repeat"></i> Continuar anterior
                            </label>
                        </div>
                    </div>

                    <!-- Segunda fila de opciones -->
                    <div class="d-flex flex-wrap gap-4 mb-2">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="sitemapOnly">
                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Solo crawlea las URLs encontradas en el sitemap. No sigue enlaces descubiertos en las pginas. Ideal para sitios con sitemap completo.">
                                <i class="bi bi-list-check"></i> Solo URLs del sitemap
                            </label>
                        </div>
                    </div>

                    <!-- Botn para expandir opciones avanzadas -->
                    <div class="mt-2">
                        <a class="text-decoration-none" data-bs-toggle="collapse" href="#advancedCrawlOptions" role="button" aria-expanded="false">
                            <i class="bi bi-gear"></i> Opciones avanzadas <i class="bi bi-chevron-down"></i>
                        </a>
                    </div>

                    <!-- Panel Colapsable de Opciones Avanzadas -->
                    <div class="collapse mt-3" id="advancedCrawlOptions">
                        <div class="card card-body bg-light">
                            <div class="row g-3">
                                <!-- Columna 1: Configuracin -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-sliders"></i> Configuracin</h6>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Delay entre requests (seg)
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Tiempo de espera entre cada peticin. Valores bajos (0.1-0.5) son ms rpidos pero pueden bloquear tu IP. Valores altos (1-3) son ms seguros."></i>
                                        </label>
                                        <input type="number" class="form-control form-control-sm" id="crawlDelay" value="0.5" min="0.1" max="5" step="0.1" />
                                    </div>

                                    <div class="mb-3" id="forceSitemapGroup" style="display: none;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="forceSitemap">
                                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="En modo 'Continuar anterior', vuelve a descargar el sitemap para descubrir nuevas URLs aadidas al sitio.">
                                                <i class="bi bi-arrow-clockwise"></i> Re-descargar Sitemap
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Selectores CSS a excluir
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Elementos HTML a ignorar (mens, footers, popups, formularios, etc.). Un selector por lnea. Ya incluye selectores de cookies por defecto."></i>
                                        </label>
                                        <textarea class="form-control form-control-sm" id="excludeSelectors" rows="8"
                                            placeholder="#header-mobile
.menu
.footer
.form
[id*='cookie']
[class*='chat']"
                                            style="font-family: monospace; font-size: 0.85rem;"></textarea>
                                        <small class="text-muted">
                                            Un selector por lnea. Acepta: <code>#id</code>, <code>.clase</code>, <code>tag</code>, <code>[atributo*='valor']</code>
                                        </small>
                                        <div class="mt-2">
                                            <small>
                                                <a href="#" onclick="event.preventDefault(); document.getElementById('excludeSelectorsHelp').style.display = document.getElementById('excludeSelectorsHelp').style.display === 'none' ? 'block' : 'none';">
                                                    <i class="bi bi-info-circle"></i> Ver selectores de cookies incluidos por defecto
                                                </a>
                                            </small>
                                        </div>
                                        <div id="excludeSelectorsHelp" style="display: none;" class="alert alert-secondary mt-2 mb-0 py-2">
                                            <small><strong>Selectores de cookies incluidos automticamente:</strong></small>
                                            <code style="font-size: 0.7rem; display: block; white-space: pre-wrap; margin-top: 5px;">#CybotCookiebotDialog, #onetrust-consent-sdk, #didomi-host, [id*='cookie'], [class*='cookie'], [id*='gdpr'], [class*='gdpr']</code>
                                        </div>
                                    </div>
                                </div>

                                <!-- Columna 2: URLs especficas -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-list-ul"></i> URLs Especficas (opcional)</h6>

                                    <div class="mb-2">
                                        <label class="form-label">
                                            Listado de URLs
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Lista de URLs especficas a crawlear. til para crawlear solo ciertas secciones o pginas concretas del sitio."></i>
                                        </label>
                                        <textarea class="form-control form-control-sm" id="urlsList" rows="3" placeholder="https://ejemplo.com/pagina1&#10;https://ejemplo.com/pagina2"></textarea>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted" id="urlsListCount">0 URLs en el listado</small>
                                            <small><a href="#" id="urlsListClear" class="text-danger" style="display: none;">Limpiar</a></small>
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="urlsOnly">
                                            <label class="form-check-label" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Si activas esto, SOLO se crawlearn las URLs del listado. No descubrir ni seguir enlaces a otras pginas.">
                                                <i class="bi bi-exclamation-triangle text-warning"></i> Solo estas URLs (no descubrir ms)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-0">
                                        <label class="form-label">
                                            Cargar desde archivo
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Sube un archivo .txt o .csv con una URL por lnea. Las lneas que empiezan con # son ignoradas."></i>
                                        </label>
                                        <input type="file" class="form-control form-control-sm" id="urlsFile" accept=".txt,.csv,.xlsx,.xls">
                                        <!-- Feedback de archivo cargado -->
                                        <div id="urlsFileFeedback" class="mt-2" style="display: none;">
                                            <div class="alert alert-success py-2 mb-0 d-flex align-items-center justify-content-between">
                                                <div>
                                                    <i class="bi bi-file-earmark-check"></i>
                                                    <strong id="urlsFileName">archivo.txt</strong>
                                                    <span class="badge bg-primary ms-2" id="urlsFileCount">0 URLs</span>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" id="urlsFileClear" title="Quitar archivo">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                            <div id="urlsFilePreview" class="small text-muted mt-1" style="max-height: 60px; overflow-y: auto; font-family: monospace;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Progreso Mejorado -->
            <div class="card mb-3" id="crawlProgressCard">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0"><i class="bi bi-activity"></i> Progreso del Crawl</h6>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge bg-secondary" id="crawlElapsedTime" style="display: none;">00:00</span>
                        <button class="btn btn-danger btn-sm" id="stopCrawl" style="display: none;">
                            <i class="bi bi-stop-fill"></i> Detener
                        </button>
                    </div>
                </div>
                <div class="card-body py-2">
                    <!-- Indicador de Fases -->
                    <div id="crawlPhases" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center small">
                            <div class="text-center flex-fill" id="phaseInit">
                                <div class="phase-icon mb-1"><i class="bi bi-play-circle"></i></div>
                                <div class="text-muted">Iniciando</div>
                            </div>
                            <div class="phase-connector"></div>
                            <div class="text-center flex-fill" id="phaseSitemap">
                                <div class="phase-icon mb-1"><i class="bi bi-diagram-3"></i></div>
                                <div class="text-muted">Sitemap</div>
                                <div class="small text-info" id="phaseSitemapCount"></div>
                            </div>
                            <div class="phase-connector"></div>
                            <div class="text-center flex-fill" id="phaseCrawl">
                                <div class="phase-icon mb-1"><i class="bi bi-globe"></i></div>
                                <div class="text-muted">Crawling</div>
                            </div>
                            <div class="phase-connector"></div>
                            <div class="text-center flex-fill" id="phaseComplete">
                                <div class="phase-icon mb-1"><i class="bi bi-check-circle"></i></div>
                                <div class="text-muted">Completado</div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado actual con URL -->
                    <div id="crawlRunningIndicator" style="display: none;" class="alert alert-info py-2 mb-2">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <div class="flex-grow-1">
                                <strong>Procesando:</strong>
                                <div class="small text-truncate" id="crawlCurrentUrl" style="max-width: 500px; font-family: monospace;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de progreso -->
                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <small id="crawlStatus">Sin crawl activo</small>
                            <small id="crawlPercent">0%</small>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="crawlProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Stats Grid Mejorado -->
                    <div class="row g-2 mb-2">
                        <div class="col-3">
                            <div class="border rounded p-2 text-center h-100">
                                <div class="fw-bold fs-5 text-success" id="statPages">0</div>
                                <small class="text-muted">Crawleadas</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border rounded p-2 text-center h-100" id="statLinksContainer" style="cursor: pointer;" data-bs-toggle="tooltip" title="Click para ver muestra de enlaces">
                                <div class="fw-bold fs-5 text-primary" id="statLinks">0</div>
                                <small class="text-muted">Enlaces <i class="bi bi-eye-fill"></i></small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border rounded p-2 text-center h-100">
                                <div class="fw-bold fs-5 text-warning" id="statQueue">0</div>
                                <small class="text-muted">En cola</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border rounded p-2 text-center h-100">
                                <div class="fw-bold fs-5 text-danger" id="statErrors">0</div>
                                <small class="text-muted">Errores</small>
                            </div>
                        </div>
                    </div>

                    <!-- Stats secundarios (skipped, etc) -->
                    <div class="d-flex gap-3 small text-muted mb-2" id="crawlSecondaryStats" style="display: none;">
                        <span><i class="bi bi-skip-forward"></i> Saltadas: <strong id="statSkipped">0</strong></span>
                        <span><i class="bi bi-files"></i> Duplicadas: <strong id="statDuplicates">0</strong></span>
                        <span><i class="bi bi-robot"></i> Robots.txt: <strong id="statRobots">0</strong></span>
                        <span><i class="bi bi-eye-slash"></i> Noindex: <strong id="statNoindex">0</strong></span>
                    </div>

                    <!-- URLs Recientes -->
                    <div id="recentUrlsContainer" style="display: none;" class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted fw-bold"><i class="bi bi-clock-history"></i> URLs recientes:</small>
                            <button class="btn btn-link btn-sm p-0" id="toggleRecentUrls">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                        <div id="recentUrlsList" class="small" style="max-height: 80px; overflow-y: auto; font-family: monospace; display: none;"></div>
                    </div>

                    <!-- Log detallado mejorado -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted fw-bold"><i class="bi bi-terminal"></i> Log de actividad</small>
                        <div>
                            <button class="btn btn-link btn-sm p-0 me-2" id="clearLog" title="Limpiar log"><i class="bi bi-trash"></i></button>
                            <button class="btn btn-link btn-sm p-0" id="toggleLogExpand" title="Expandir/contraer"><i class="bi bi-arrows-expand"></i></button>
                        </div>
                    </div>
                    <div class="crawl-log" id="crawlLog" style="max-height: 150px;">
                        <div class="log-entry text-muted"><i class="bi bi-info-circle"></i> Esperando inicio de crawl...</div>
                    </div>
                </div>
            </div>

            <!-- Modal para ver enlaces extrados -->
            <div class="modal fade" id="linksPreviewModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-link-45deg"></i> Enlaces Extrados</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Filtros como pestaas clickables -->
                            <div class="d-flex gap-2 mb-3 flex-wrap" id="linksFilterTabs">
                                <button class="btn btn-outline-primary active" data-location="" id="linkFilterAll">
                                    <i class="bi bi-list"></i> Todos <span class="badge bg-primary" id="linksTotal">0</span>
                                </button>
                                <button class="btn btn-outline-success" data-location="content" id="linkFilterContent">
                                    <i class="bi bi-file-text"></i> Contenido <span class="badge bg-success" id="linksContent">0</span>
                                </button>
                                <button class="btn btn-outline-info" data-location="nav" id="linkFilterNav">
                                    <i class="bi bi-menu-button-wide"></i> Navegacin <span class="badge bg-info" id="linksNav">0</span>
                                </button>
                                <button class="btn btn-outline-warning" data-location="sidebar" id="linkFilterSidebar">
                                    <i class="bi bi-layout-sidebar"></i> Sidebar <span class="badge bg-warning" id="linksSidebar">0</span>
                                </button>
                                <button class="btn btn-outline-secondary" data-location="footer" id="linkFilterFooter">
                                    <i class="bi bi-layout-text-window-reverse"></i> Footer <span class="badge bg-secondary" id="linksFooter">0</span>
                                </button>
                            </div>
                            <!-- Info de filtro activo -->
                            <div class="mb-2 small text-muted" id="linksFilterInfo">
                                Mostrando <strong id="linksShowing">0</strong> de <strong id="linksFilteredTotal">0</strong> enlaces
                            </div>
                            <!-- Tabla de enlaces -->
                            <div class="table-responsive" style="max-height: 450px;">
                                <table class="table table-sm table-hover">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th style="width: 45%">URL Destino</th>
                                            <th style="width: 30%">Anchor Text</th>
                                            <th style="width: 15%">Ubicacin</th>
                                            <th style="width: 10%">Peso</th>
                                        </tr>
                                    </thead>
                                    <tbody id="linksPreviewTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crawls Disponibles - Pipeline Actions -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-collection"></i> Crawls Disponibles
                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Lista de todos los crawls realizados. Desde aqu puedes ver su estado, limpiarlos o ingerirlos a la base de datos."></i>
                    </h6>
                    <button class="btn btn-sm btn-outline-primary" id="refreshCrawlsList">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
                <div class="card-body py-2">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="crawlsPipelineTable">
                            <thead>
                                <tr>
                                    <th>Dominio</th>
                                    <th class="text-center" data-bs-toggle="tooltip" title="Nmero de pginas crawleadas">Pgs</th>
                                    <th class="text-center" data-bs-toggle="tooltip" title="Se guard el HTML original? Necesario para Smart Cleaner">HTML</th>
                                    <th class="text-center" data-bs-toggle="tooltip" title="Se aplic limpieza de markdown?">Limpio</th>
                                    <th class="text-center" data-bs-toggle="tooltip" title="Ya est en la base de datos para RAG?">Ingestado</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="crawlsPipelineBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Cargando crawls...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pipeline flow mini -->
                    <div class="border-top pt-2 mt-2">
                        <small class="text-muted d-flex align-items-center gap-2 flex-wrap">
                            <strong>Pipeline:</strong>
                            <span class="badge bg-primary"><i class="bi bi-globe"></i> Crawler</span>
                            <i class="bi bi-arrow-right"></i>
                            <span class="badge bg-warning text-dark"><i class="bi bi-scissors"></i> Cleaner</span>
                            <i class="bi bi-arrow-right"></i>
                            <span class="badge bg-success"><i class="bi bi-database-add"></i> Ingesta</span>
                            <i class="bi bi-arrow-right"></i>
                            <span class="badge bg-info"><i class="bi bi-chat-dots"></i> RAG</span>
                        </small>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ingestion Section -->
        <section id="ingest" class="section">
            <div class="page-header">
                <h1 class="page-title">Ingestin de Datos</h1>
                <p class="page-subtitle">Explora y selecciona documentos crawleados para importar</p>
            </div>

            <div class="row">
                <!-- Left: Crawl selector and document explorer -->
                <div class="col-lg-8">
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title"><i class="bi bi-folder2-open"></i> Explorador de Documentos</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <select class="form-select" id="ingestCrawlSelect" style="width: auto; min-width: 200px;">
                                    <option value="">Selecciona un crawl...</option>
                                </select>
                                <button class="btn btn-outline-danger btn-sm" id="deleteCrawlBtn" style="display: none;" title="Eliminar todo el crawl">
                                    <i class="bi bi-trash"></i> Eliminar Crawl
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters -->
                            <div class="row mb-3" id="ingestFilters" style="display: none;">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="ingestSearchFilter" placeholder="Buscar por URL o ttulo...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="ingestMinWords">
                                        <option value="0">Todas las pginas</option>
                                        <option value="50" selected>Min. 50 palabras</option>
                                        <option value="100">Min. 100 palabras</option>
                                        <option value="200">Min. 200 palabras</option>
                                        <option value="500">Min. 500 palabras</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" id="ingestSelectAll">
                                        <label class="form-check-label">Seleccionar todas</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats -->
                            <div id="ingestStats" class="alert alert-info mb-3" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><strong id="ingestTotalPages">0</strong> pginas totales</span>
                                    <span><strong id="ingestFilteredPages">0</strong> filtradas</span>
                                    <span><strong id="ingestSelectedPages">0</strong> seleccionadas</span>
                                    <button class="btn btn-outline-danger btn-sm" id="deleteSelectedBtn" style="display: none;">
                                        <i class="bi bi-trash"></i> Eliminar seleccionadas
                                    </button>
                                </div>
                            </div>

                            <!-- Document List -->
                            <div id="ingestDocumentList" style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center py-4">
                                    <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i><br>
                                    Selecciona un crawl para ver los documentos disponibles
                                </p>
                            </div>

                            <!-- Pagination -->
                            <div id="ingestPagination" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                                <button class="btn btn-sm btn-outline-secondary" id="ingestPrevPage" disabled>
                                    <i class="bi bi-chevron-left"></i> Anterior
                                </button>
                                <span id="ingestPageInfo">Pgina 1</span>
                                <button class="btn btn-sm btn-outline-secondary" id="ingestNextPage">
                                    Siguiente <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Ingest configuration -->
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-gear"></i> Configuracin</h5>
                        </div>
                        <div class="card-body">
                            <input type="hidden" id="ingestPath" />
                            <div class="form-group mb-3">
                                <label>Nombre del Cliente *</label>
                                <input type="text" class="form-control" id="ingestClientName" placeholder="Mi Cliente" />
                            </div>
                            <div class="form-group mb-3">
                                <label>Dominio *</label>
                                <input type="text" class="form-control" id="ingestDomain" placeholder="ejemplo.com" />
                            </div>
                            <div class="form-group mb-3">
                                <label>Modo de Ingesta</label>
                                <select class="form-control" id="ingestMode">
                                    <option value="new_only">Solo nuevas (no sobrescribir)</option>
                                    <option value="overwrite">Sobrescribir existentes</option>
                                    <option value="full_refresh">Borrar todo y reimportar</option>
                                </select>
                                <small class="text-muted">Controla cmo se manejan pginas existentes</small>
                            </div>
                            <div class="form-group mb-3">
                                <label>Modelo de Embeddings</label>
                                <select class="form-control" id="ingestEmbeddingModel">
                                    <option value="hiiamsid/sentence_similarity_spanish_es" data-dim="768">Espaol (hiiamsid) - 768 dims</option>
                                    <option value="intfloat/multilingual-e5-large" data-dim="1024">Multilinge E5 - 1024 dims</option>
                                    <option value="sentence-transformers/paraphrase-multilingual-mpnet-base-v2" data-dim="768">Multilinge MPNet - 768 dims</option>
                                </select>
                                <small class="text-muted">Modelo para generar vectores semnticos</small>
                            </div>
                            <div class="form-group mb-3">
                                <label>Palabras mnimas</label>
                                <input type="number" class="form-control" id="ingestMinWordCount" value="50" min="0" />
                                <small class="text-muted">Pginas con menos palabras se ignoran</small>
                            </div>
                            <div class="form-group mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="deleteAfterIngest">
                                    <label class="form-check-label">Eliminar archivos despus</label>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" id="startIngest" disabled>
                                <i class="bi bi-database-add"></i> Iniciar Ingestin
                            </button>
                            <div id="ingestStatus" class="mt-3"></div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Preview Modal (Fullscreen) -->
        <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content" style="background: var(--bg-card); border: none;">
                    <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                        <div class="d-flex flex-column flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <i class="bi bi-file-text text-primary"></i>
                                <h5 class="modal-title mb-0" id="previewModalLabel">
                                    <span id="previewTitle">Preview del documento</span>
                                </h5>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted text-truncate" id="previewUrl" style="max-width: 500px;"></small>
                                <span id="previewWords" class="ms-2"></span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div id="previewContent" class="preview-content">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-3 text-muted">Cargando contenido...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                        <a href="#" id="previewOpenUrl" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i> Abrir URL
                        </a>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cleaner Preview Modal -->
        <div class="modal fade" id="cleanerPreviewModal" tabindex="-1" aria-labelledby="cleanerPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                    <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                        <h5 class="modal-title" id="cleanerPreviewModalLabel">
                            <i class="bi bi-eye me-2"></i> Vista Previa de Limpieza
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center p-2">
                                        <h6 class="mb-0" id="previewTotalPages">0</h6>
                                        <small class="text-muted">Pginas</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center p-2">
                                        <h6 class="mb-0" id="previewAvgReduction">0%</h6>
                                        <small class="text-muted">Reduccin Promedio</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center p-2">
                                        <h6 class="mb-0" id="previewPatternsCount">0</h6>
                                        <small class="text-muted">Patrones</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h6><i class="bi bi-list"></i> Pginas afectadas:</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th class="text-end">Original</th>
                                        <th class="text-end">Limpio</th>
                                        <th class="text-end">Reduccin</th>
                                    </tr>
                                </thead>
                                <tbody id="previewPagesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-success" id="applyFromPreviewBtn">
                            <i class="bi bi-check-circle"></i> Aplicar Limpieza
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Cleaner Section -->
        <section id="cleaner" class="section">
            <div class="page-header">
                <h1 class="page-title"><i class="bi bi-scissors me-2"></i>Manual Cleaner</h1>
                <p class="page-subtitle">Limpieza manual de markdown - Define patrones para eliminar contenido no deseado</p>
            </div>

            <!-- Breadcrumb de navegacin -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb" id="cleanerBreadcrumb">
                    <li class="breadcrumb-item active" id="bcStep1">
                        <i class="bi bi-folder2"></i> Crawls
                    </li>
                </ol>
            </nav>

            <!-- Step 1: Select Crawl - Layout en tabla compacta -->
            <div id="cleanerStep1">
                <div class="card">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-folder2-open"></i> Selecciona un Crawl
                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip"
                               title="Elige el crawl que quieres limpiar. Solo se muestran crawls con contenido HTML guardado."></i>
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" id="refreshCleanerCrawls">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body py-2">
                        <div id="cleanerCrawlsList">
                            <div class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm"></div> Cargando crawls...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Templates List - Layout en dos columnas -->
            <div id="cleanerStep2" style="display: none;">
                <div class="row">
                    <!-- Columna izquierda: Lista de plantillas -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-layers"></i> Plantillas
                                    <span class="badge bg-secondary ms-1" id="cleanerCrawlName"></span>
                                </h6>
                                <button class="btn btn-sm btn-outline-secondary" id="backToCrawls">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                            </div>
                            <div class="card-body py-2">
                                <!-- Quick Auto-Clean for all pages -->
                                <div class="border rounded mb-3 p-2" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <span class="fw-semibold" style="font-size: 0.85rem;">
                                            <i class="bi bi-magic text-primary"></i> Auto-limpiar
                                        </span>
                                        <button class="btn btn-sm btn-primary px-3" id="autoCleanAllBtn">
                                            <i class="bi bi-lightning-fill"></i> Aplicar
                                        </button>
                                    </div>
                                    <div class="d-flex gap-3" style="font-size: 0.75rem;">
                                        <label class="d-flex align-items-center gap-1 mb-0" style="cursor: pointer;">
                                            <input type="checkbox" id="acAllHeading" checked class="form-check-input m-0" style="width: 14px; height: 14px;">
                                            <span>Desde H1</span>
                                        </label>
                                        <label class="d-flex align-items-center gap-1 mb-0" style="cursor: pointer;">
                                            <input type="checkbox" id="acAllFooter" checked class="form-check-input m-0" style="width: 14px; height: 14px;">
                                            <span>Sin footer</span>
                                        </label>
                                        <label class="d-flex align-items-center gap-1 mb-0" style="cursor: pointer;">
                                            <input type="checkbox" id="acAllNav" checked class="form-check-input m-0" style="width: 14px; height: 14px;">
                                            <span>Sin nav</span>
                                        </label>
                                    </div>
                                    <!-- Status indicator -->
                                    <div id="autoCleanStatus" class="mt-2 pt-2 border-top border-primary-subtle" style="display: none;">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-success d-flex align-items-center gap-1">
                                                <i class="bi bi-check-circle-fill"></i> Aplicado
                                            </span>
                                            <small class="text-muted" id="autoCleanStats"></small>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted d-block mb-2">
                                    <i class="bi bi-info-circle"></i> O selecciona plantilla para limpieza manual:
                                </small>
                                <div id="cleanerTemplatesList" style="max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha: Info de plantilla seleccionada -->
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header py-2">
                                <h6 class="card-title mb-0"><i class="bi bi-eye"></i> Vista Previa de Plantilla</h6>
                            </div>
                            <div class="card-body" id="templatePreviewArea">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-hand-index" style="font-size: 2rem;"></i>
                                    <p class="mt-2">Selecciona una plantilla de la izquierda para ver una muestra</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Template Editor - Layout optimizado -->
            <div id="cleanerStep3" style="display: none;">
                <div class="row">
                    <!-- Columna izquierda: Editor de patrones compacto -->
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-pencil-square"></i> Editor
                                    <span class="badge bg-primary ms-1" id="editorTemplateId"></span>
                                </h6>
                                <button class="btn btn-sm btn-outline-secondary" id="backToTemplates">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                            </div>
                            <div class="card-body py-2">
                                <!-- Info rpida -->
                                <div class="alert alert-light py-1 px-2 mb-2 d-flex justify-content-between align-items-center">
                                    <small><i class="bi bi-files"></i> <span id="editorPageCount">0</span></small>
                                    <small><i class="bi bi-percent"></i> Reduccin: <strong id="reductionPct">0%</strong></small>
                                </div>

                                <!-- Instrucciones -->
                                <div class="alert alert-info py-1 px-2 mb-2" style="font-size: 0.75rem;">
                                    <i class="bi bi-info-circle"></i> <strong>Selecciona texto</strong> en el panel "Original" para crear patrones
                                </div>

                                <!-- Reutilizar patrones de otras plantillas -->
                                <div class="mb-2" id="availablePatternsSection" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-muted"><i class="bi bi-arrow-repeat"></i> Reutilizar de otras plantillas:</small>
                                        <button class="btn btn-link btn-sm p-0" onclick="window.refreshAvailablePatterns()" title="Recargar">
                                            <i class="bi bi-arrow-clockwise" style="font-size: 0.7rem;"></i>
                                        </button>
                                    </div>
                                    <div id="availablePatternsList" class="d-flex flex-wrap gap-1" style="max-height: 80px; overflow-y: auto;">
                                        <!-- Se llena dinmicamente -->
                                    </div>
                                </div>

                                <!-- Add Pattern Form - Simplificado -->
                                <div class="border rounded p-2 mb-2 bg-light">
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <div class="btn-group btn-group-sm w-100" role="group" id="patternTypeButtons">
                                                <input type="radio" class="btn-check" name="patternType" id="pt_contains" value="contains" checked>
                                                <label class="btn btn-outline-primary" for="pt_contains" title="Eliminar lneas que contienen este texto">Contiene</label>

                                                <input type="radio" class="btn-check" name="patternType" id="pt_exact" value="exact">
                                                <label class="btn btn-outline-primary" for="pt_exact" title="Eliminar exactamente este texto">Exacto</label>

                                                <input type="radio" class="btn-check" name="patternType" id="pt_line_range" value="line_range">
                                                <label class="btn btn-outline-primary" for="pt_line_range" title="Eliminar desde...hasta (primera ocurrencia)">Rango</label>

                                                <input type="radio" class="btn-check" name="patternType" id="pt_text_range" value="text_range">
                                                <label class="btn btn-outline-primary" for="pt_text_range" title="Eliminar desde...hasta (TODAS las ocurrencias)">Rango x N</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <textarea class="form-control form-control-sm" id="patternValue" placeholder="Selecciona texto del original o escribe aqu... (puedes pegar bloques grandes de texto)" rows="4" style="resize: vertical; min-height: 80px; max-height: 300px;"></textarea>
                                            <small class="text-muted" id="patternCharCount"></small>
                                        </div>
                                        <div class="col-12" id="patternEndContainer" style="display: none;">
                                            <input type="text" class="form-control form-control-sm" id="patternValueEnd" placeholder="Texto final del rango...">
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-sm btn-success w-100" id="addPatternBtn">
                                                <i class="bi bi-plus"></i> Aadir Patrn
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Patrones activos -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted"><i class="bi bi-list-check"></i> Patrones activos</small>
                                </div>
                                <div id="patternsList" style="max-height: 200px; overflow-y: auto;">
                                    <p class="text-muted small text-center py-2">Sin patrones</p>
                                </div>

                                <!-- Auto-Clean Options -->
                                <div class="border rounded p-2 mb-2 bg-light">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="fw-bold"><i class="bi bi-magic"></i> Auto-limpieza</small>
                                        <input type="checkbox" class="form-check-input" id="enableAutoClean" checked>
                                    </div>
                                    <div id="autoCleanOptions" style="font-size: 0.75rem;">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="acExtractHeading" checked>
                                            <label class="form-check-label" for="acExtractHeading" title="Elimina todo antes del primer ttulo H1/H2">Desde H1</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="acRemoveFooter" checked>
                                            <label class="form-check-label" for="acRemoveFooter" title="Elimina footer, copyright, redes sociales">Sin footer</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="acRemoveNav" checked>
                                            <label class="form-check-label" for="acRemoveNav" title="Elimina breadcrumbs y mens">Sin nav</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="acCleanLines" checked>
                                            <label class="form-check-label" for="acCleanLines" title="Mximo 2 lneas vacas">Limpiar</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn btn-primary btn-sm" id="previewCleaningBtn">
                                        <i class="bi bi-eye"></i> Vista Previa Global
                                    </button>
                                    <button class="btn btn-success btn-sm" id="applyCleaningBtn" disabled>
                                        <i class="bi bi-check-circle"></i> Aplicar a <span id="applyPageCount">0</span> pginas
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Navegacin de muestras -->
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="card-title mb-0"><i class="bi bi-collection"></i> Muestras</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary" id="prevSampleBtn">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <span class="badge bg-secondary" id="sampleIndicator">1 / 1</span>
                                    <button class="btn btn-sm btn-outline-secondary" id="nextSampleBtn">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1 text-truncate" id="sampleUrl" title=""></small>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha: Preview del contenido -->
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header py-2">
                                <!-- Pipeline indicator -->
                                <div class="d-flex align-items-center justify-content-between mb-2" style="font-size: 0.75rem;">
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="badge bg-secondary" id="pipelineStep1">
                                            <i class="bi bi-globe"></i> Crawler
                                        </span>
                                        <i class="bi bi-arrow-right text-muted"></i>
                                        <span class="badge" id="pipelineStep2" style="background: #6c757d;">
                                            <i class="bi bi-magic"></i> Auto-clean
                                        </span>
                                        <i class="bi bi-arrow-right text-muted"></i>
                                        <span class="badge bg-primary">
                                            <i class="bi bi-pencil"></i> Patrones
                                        </span>
                                        <i class="bi bi-arrow-right text-muted"></i>
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Final
                                        </span>
                                    </div>
                                    <div>
                                        <span class="badge bg-secondary" id="originalLength" title="Tamao entrada">0</span>
                                        <i class="bi bi-arrow-right text-muted"></i>
                                        <span class="badge bg-success" id="previewLength" title="Tamao salida">0</span>
                                        <span class="badge bg-info" id="reductionBadge" title="Reduccin">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="row g-0" style="height: 600px;">
                                    <div class="col-6 border-end d-flex flex-column">
                                        <div class="p-2 bg-light border-bottom d-flex justify-content-between align-items-center">
                                            <div>
                                                <small id="leftPanelLabel" class="fw-bold text-secondary"><i class="bi bi-file-earmark"></i> Entrada</small>
                                                <small id="leftPanelSubLabel" class="text-muted ms-1" style="font-size: 0.65rem;">(del crawler)</small>
                                            </div>
                                            <small class="text-muted">Selecciona texto <i class="bi bi-hand-index"></i></small>
                                        </div>
                                        <div id="markdownOriginal" class="preview-content p-2 flex-grow-1 markdown-selectable" style="overflow-y: auto; font-size: 0.8rem; line-height: 1.4; cursor: text; user-select: text;"></div>
                                    </div>
                                    <div class="col-6 d-flex flex-column">
                                        <div class="p-2 bg-light border-bottom">
                                            <small class="fw-bold text-success"><i class="bi bi-file-earmark-check"></i> Salida</small>
                                            <small class="text-muted ms-1" style="font-size: 0.65rem;">(tras patrones)</small>
                                        </div>
                                        <div id="markdownPreview" class="preview-content p-2 flex-grow-1" style="overflow-y: auto; font-size: 0.8rem; line-height: 1.4;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Clients Section -->
        <section id="clients" class="section">
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="page-title">Clientes</h1>
                    <p class="page-subtitle">Gestin de clientes multi-tenant</p>
                </div>
                <button class="btn btn-primary" id="newClientBtn">
                    <i class="bi bi-plus-lg"></i> Nuevo Cliente
                </button>
            </div>

            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-card-icon primary">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="stats-card-value" id="totalClients">0</div>
                    <div class="stats-card-label">Total Clientes</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-icon success">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="stats-card-value" id="totalPages">0</div>
                    <div class="stats-card-label">Pginas Indexadas</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-icon warning">
                        <i class="bi bi-link-45deg"></i>
                    </div>
                    <div class="stats-card-value" id="totalLinks">0</div>
                    <div class="stats-card-label">Enlaces</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-icon danger">
                        <i class="bi bi-cpu"></i>
                    </div>
                    <div class="stats-card-value" id="totalEmbeddings">0</div>
                    <div class="stats-card-label">Embeddings</div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <table class="clients-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Dominio</th>
                                <th>Pginas</th>
                                <th>Enlaces</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Cargando clientes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="page-header">
                <h1 class="page-title">Configuracin</h1>
                <p class="page-subtitle">Ajustes del sistema</p>
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-server"></i> Conexiones</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label>API URL</label>
                                <input type="text" class="form-control" id="apiUrl" value="http://localhost:8080" />
                            </div>
                            <div class="form-group mb-3">
                                <label>Supabase URL</label>
                                <input type="text" class="form-control" id="supabaseUrl" value="http://localhost:54321" disabled />
                            </div>
                            <div class="form-group mb-3">
                                <label>Neo4j URI</label>
                                <input type="text" class="form-control" id="neo4jUri" value="bolt://localhost:7688" disabled />
                            </div>
                            <button class="btn btn-primary" id="testConnections">
                                <i class="bi bi-wifi"></i> Probar Conexiones
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-cpu"></i> Modelo de Embeddings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label>Modelo</label>
                                <input type="text" class="form-control" value="intfloat/multilingual-e5-large" disabled />
                            </div>
                            <div class="form-group mb-3">
                                <label>Dimensiones</label>
                                <input type="text" class="form-control" value="1024" disabled />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-gear"></i> RAG Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label>Top K Vectores</label>
                                <input type="number" class="form-control" id="ragTopK" value="10" />
                            </div>
                            <div class="form-group mb-3">
                                <label>Saltos de Grafo</label>
                                <input type="number" class="form-control" id="ragHops" value="2" />
                            </div>
                            <div class="form-group mb-3">
                                <label>Mx. Pginas Contexto</label>
                                <input type="number" class="form-control" id="ragMaxPages" value="15" />
                            </div>
                            <div class="form-group mb-3">
                                <label>Similitud Mnima</label>
                                <input type="number" class="form-control" id="ragMinSim" value="0.5" step="0.1" />
                            </div>
                            <button class="btn btn-primary" id="saveSettings">
                                <i class="bi bi-check-lg"></i> Guardar Configuracin
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="bi bi-info-circle"></i> Sistema</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Versin:</strong> 1.0.0</p>
                            <p><strong>Entorno:</strong> Desarrollo</p>
                            <p><strong>Python:</strong> 3.11+</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- New Client Modal -->
    <div class="modal-overlay" id="newClientModal">
        <div class="modal">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo Cliente</h5>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label>Nombre del Cliente *</label>
                    <input type="text" class="form-control" id="newClientName" placeholder="Nombre del cliente" />
                </div>
                <div class="form-group">
                    <label>Dominio *</label>
                    <input type="text" class="form-control" id="newClientDomain" placeholder="ejemplo.com" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelClient">Cancelar</button>
                <button class="btn btn-primary" id="createClient">Crear Cliente</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const API_URL = localStorage.getItem('apiUrl') || 'http://localhost:8080';

        // State
        let currentClient = null;
        let clients = [];

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            icon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }

        // Mobile Menu
        function initMobileMenu() {
            const menuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.querySelector('.sidebar');

            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            });
        }

        // DOM Ready
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            initMobileMenu();
            initNavigation();
            initChat();
            initSearch();
            initCrawler();
            initIngest();
            initCleaner();
            initClients();
            initSettings();
            initInterlinking();
            initGraphExplorer();
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
            // Load clients AFTER all init functions so the overrides are in place
            await loadClients();
        });

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const section = item.dataset.section;
                    if (!section) return;

                    // Update nav
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Update sections
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById(section).classList.add('active');
                });
            });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle result content expansion
        function toggleResultContent(idx) {
            const content = document.getElementById(`content-${idx}`);
            const btn = document.getElementById(`expand-btn-${idx}`);
            const markdownDiv = document.getElementById(`markdown-${idx}`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.innerHTML = '<i class="bi bi-chevron-down"></i> Ver contenido';
            } else {
                // Render markdown on first expand
                if (markdownDiv.innerHTML === '' && window.searchResults && window.searchResults[idx]) {
                    const rawContent = window.searchResults[idx].chunk_content || 'Sin contenido';
                    try {
                        markdownDiv.innerHTML = marked.parse(rawContent);
                    } catch (e) {
                        markdownDiv.textContent = rawContent;
                    }
                }
                content.classList.add('expanded');
                btn.innerHTML = '<i class="bi bi-chevron-up"></i> Ocultar';
            }
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Load clients
        async function loadClients() {
            try {
                const response = await fetch(`${API_URL}/api/v1/dashboard/clients`);
                if (response.ok) {
                    clients = await response.json();
                    updateClientSelects();
                    updateClientsTable();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function updateClientSelects() {
            // Actualizar todos los selectores de cliente
            const selectIds = ['#chatClientSelect', '#searchClientSelect', '#interlinkingClientSelect'];
            const allSelects = [];

            selectIds.forEach(id => {
                const select = document.querySelector(id);
                if (select) allSelects.push(select);
            });

            allSelects.forEach(select => {
                select.innerHTML = clients.length
                    ? clients.map(c => `<option value="${c.id}">${c.name} (${c.domain})</option>`).join('')
                    : '<option value="">No hay clientes</option>';

                // Establecer el primer cliente como valor por defecto
                if (clients.length) {
                    select.value = clients[0].id;
                }
            });

            if (clients.length) {
                currentClient = clients[0].id;
            }
        }

        function updateClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            if (!clients.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay clientes registrados</td></tr>';
                return;
            }
            tbody.innerHTML = clients.map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td class="client-domain">${c.domain}</td>
                    <td>${c.pages_count || 0}</td>
                    <td>${c.links_count || 0}</td>
                    <td><span class="badge badge-success">${c.is_active !== false ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="viewClientStats('${c.id}')" title="Ver estadsticas">
                                <i class="bi bi-bar-chart"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="calculateScores('${c.id}')" title="Calcular PageRank/HITS">
                                <i class="bi bi-calculator"></i>
                            </button>
                            <button class="btn btn-info btn-sm" onclick="viewGraph('${c.id}')" title="Ver grafo">
                                <i class="bi bi-diagram-3"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="regenerateEmbeddings('${c.id}')" title="Regenerar embeddings">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="rotateApiKey('${c.id}')" title="Rotar API Key">
                                <i class="bi bi-key"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteClient('${c.id}')" title="Eliminar cliente">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            const totalPages = clients.reduce((sum, c) => sum + (c.pages_count || 0), 0);
            const totalLinks = clients.reduce((sum, c) => sum + (c.links_count || 0), 0);
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalLinks').textContent = totalLinks;
            document.getElementById('totalEmbeddings').textContent = totalPages; // Approximate
        }

        // Chat functionality
        function initChat() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendMessage');
            const messagesDiv = document.getElementById('chatMessages');

            // Mode selector buttons
            const modeButtons = document.querySelectorAll('.mode-btn');
            let currentMode = 'balanced';

            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;

                    // Apply mode presets
                    const useReranking = document.getElementById('useReranking');
                    const useGraph = document.getElementById('useGraph');
                    const useCommunities = document.getElementById('useCommunities');
                    const maxChunks = document.getElementById('maxChunks');
                    const minSim = document.getElementById('minSim');

                    switch(currentMode) {
                        case 'fast':
                            useReranking.checked = false;
                            useGraph.checked = false;
                            useCommunities.checked = false;
                            maxChunks.value = 8;
                            minSim.value = 0.5;
                            break;
                        case 'balanced':
                            useReranking.checked = true;
                            useGraph.checked = true;
                            useCommunities.checked = true;
                            maxChunks.value = 15;
                            minSim.value = 0.3;
                            break;
                        case 'exhaustive':
                            useReranking.checked = true;
                            useGraph.checked = true;
                            useCommunities.checked = true;
                            maxChunks.value = 25;
                            minSim.value = 0.2;
                            break;
                    }
                    // Update displayed values
                    document.getElementById('maxChunksValue').textContent = maxChunks.value;
                    document.getElementById('minSimValue').textContent = minSim.value;
                });
            });

            // Advanced options toggle
            document.getElementById('showAdvanced').addEventListener('click', (e) => {
                e.preventDefault();
                const advDiv = document.getElementById('advancedOptions');
                const isHidden = advDiv.style.display === 'none';
                advDiv.style.display = isHidden ? 'block' : 'none';
                e.target.innerHTML = isHidden
                    ? '<i class="bi bi-gear-fill"></i> Ocultar avanzadas'
                    : '<i class="bi bi-gear"></i> Opciones avanzadas';
            });

            // Range sliders
            ['maxChunks', 'graphHops', 'minSim'].forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + 'Value');
                if (slider && valueSpan) {
                    slider.addEventListener('input', () => {
                        valueSpan.textContent = slider.value;
                    });
                }
            });

            async function sendMessage() {
                const query = input.value.trim();
                if (!query) return;

                // Add user message
                messagesDiv.innerHTML += `<div class="message user"><p>${query}</p></div>`;
                input.value = '';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                // Add loading
                const loadingId = 'loading-' + Date.now();
                messagesDiv.innerHTML += `<div class="message assistant" id="${loadingId}"><div class="spinner"></div></div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                try {
                    const clientId = document.getElementById('chatClientSelect').value;
                    const useReranking = document.getElementById('useReranking').checked;
                    const useGraph = document.getElementById('useGraph').checked;
                    const graphHops = useGraph ? parseInt(document.getElementById('graphHops').value) : 0;

                    const response = await fetch(`${API_URL}/api/v1/dashboard/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query,
                            client_id: clientId,
                            top_k: parseInt(document.getElementById('maxChunks').value),
                            graph_hops: graphHops,
                            min_similarity: parseFloat(document.getElementById('minSim').value),
                            use_reranking: useReranking
                        })
                    });

                    const data = await response.json();
                    const loading = document.getElementById(loadingId);

                    if (response.ok) {
                        let sourcesHtml = '';
                        if (data.sources && data.sources.length) {
                            const sourceLinks = data.sources.map(s => {
                                const title = s.title || s.url;
                                const shortTitle = title.length > 50 ? title.substring(0, 47) + '...' : title;
                                return `<a href="${s.url}" target="_blank" class="source-link" title="${title}">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    ${shortTitle}
                                </a>`;
                            }).join('');
                            sourcesHtml = `
                                <div class="message-sources">
                                    <strong> Fuentes consultadas (${data.sources.length})</strong>
                                    <div class="sources-list">${sourceLinks}</div>
                                </div>
                            `;
                        }
                        const answerHtml = marked.parse(data.answer || data.response || '');

                        // Context stats footer
                        let statsHtml = '';
                        if (data.context_stats) {
                            const stats = data.context_stats;
                            const badges = [];
                            if (stats.vector_results) badges.push(` ${stats.vector_results} vectores`);
                            if (stats.graph_expanded) badges.push(` ${stats.graph_expanded} grafo`);
                            if (stats.reranked) badges.push(' reranked');
                            if (badges.length) {
                                statsHtml = `<div class="rag-stats">${badges.join('  ')}</div>`;
                            }
                        }

                        loading.innerHTML = `<div class="rag-markdown">${answerHtml}</div>${sourcesHtml}${statsHtml}`;
                    } else {
                        loading.innerHTML = `<p class="text-danger">Error: ${data.detail || 'Error desconocido'}</p>`;
                    }
                } catch (error) {
                    const loading = document.getElementById(loadingId);
                    loading.innerHTML = `<p class="text-danger">Error de conexin: ${error.message}</p>`;
                }

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // Search functionality
        function initSearch() {
            const input = document.getElementById('searchInput');
            const results = document.getElementById('searchResults');
            const statsDiv = document.getElementById('searchStats');
            const filtersContainer = document.getElementById('searchFilters');
            let searchTimeout;
            let currentFilter = 'all';

            // Initialize search client select
            const searchClientSelect = document.getElementById('searchClientSelect');
            if (searchClientSelect && clients.length) {
                searchClientSelect.innerHTML = clients.map(c =>
                    `<option value="${c.id}" ${c.id === currentClient ? 'selected' : ''}>${c.name}</option>`
                ).join('');

                // Load filters when client changes
                searchClientSelect.addEventListener('change', () => {
                    loadUrlPatterns(searchClientSelect.value);
                });

                // Load initial filters
                loadUrlPatterns(searchClientSelect.value || currentClient);
            }

            // Function to load dynamic URL patterns
            async function loadUrlPatterns(clientId) {
                if (!clientId) return;

                const loadingEl = document.getElementById('filtersLoading');
                if (loadingEl) loadingEl.style.display = 'inline';

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/url-patterns/${clientId}`);
                    const data = await response.json();

                    // Clear existing dynamic filters (keep "Todos")
                    const existingChips = filtersContainer.querySelectorAll('.filter-chip:not([data-filter="all"])');
                    existingChips.forEach(chip => chip.remove());

                    // Add new filters from patterns
                    if (data.patterns && data.patterns.length > 0) {
                        data.patterns.forEach(pattern => {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.dataset.filter = pattern.filter;
                            chip.innerHTML = `${pattern.label} <small class="text-muted">(${pattern.count})</small>`;
                            chip.title = `Filtrar por URLs que contienen "/${pattern.filter}"`;
                            chip.addEventListener('click', () => {
                                filtersContainer.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                                chip.classList.add('active');
                                currentFilter = pattern.filter;
                                if (input.value.trim().length >= 2) {
                                    performSearch();
                                }
                            });
                            filtersContainer.insertBefore(chip, loadingEl);
                        });
                    }
                } catch (error) {
                    console.error('Error loading URL patterns:', error);
                } finally {
                    if (loadingEl) loadingEl.style.display = 'none';
                }
            }

            // Refresh filters button
            document.getElementById('refreshFilters')?.addEventListener('click', () => {
                const clientId = searchClientSelect?.value || document.getElementById('chatClientSelect').value;
                loadUrlPatterns(clientId);
            });

            // Search sliders
            ['searchTopK', 'searchMinSim'].forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + 'Value');
                if (slider && valueSpan) {
                    slider.addEventListener('input', () => {
                        valueSpan.textContent = slider.value;
                    });
                    // Trigger search on change
                    slider.addEventListener('change', () => {
                        if (input.value.trim().length >= 2) {
                            input.dispatchEvent(new Event('input'));
                        }
                    });
                }
            });

            // URL filter input
            const urlFilterInput = document.getElementById('searchUrlFilter');
            if (urlFilterInput) {
                urlFilterInput.addEventListener('change', () => {
                    if (input.value.trim().length >= 2) {
                        input.dispatchEvent(new Event('input'));
                    }
                });
            }

            async function performSearch() {
                const query = input.value.trim();
                if (query.length < 2) {
                    results.innerHTML = '<p class="text-muted text-center mt-4">Escribe al menos 2 caracteres...</p>';
                    statsDiv.style.display = 'none';
                    return;
                }

                const startTime = Date.now();

                try {
                    const clientId = document.getElementById('searchClientSelect')?.value || document.getElementById('chatClientSelect').value;
                    const topK = parseInt(document.getElementById('searchTopK')?.value || 15);
                    const minSim = parseFloat(document.getElementById('searchMinSim')?.value || 0.2);
                    const urlFilter = document.getElementById('searchUrlFilter')?.value?.trim() || '';

                    const response = await fetch(`${API_URL}/api/v1/dashboard/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query,
                            client_id: clientId,
                            top_k: topK,
                            min_similarity: minSim,
                            url_filter: urlFilter || (currentFilter !== 'all' ? currentFilter : null)
                        })
                    });

                    const data = await response.json();
                    const elapsed = Date.now() - startTime;

                    if (response.ok && data.results) {
                        // Apply client-side filter if chip is selected
                        let filteredResults = data.results;
                        if (currentFilter !== 'all') {
                            filteredResults = data.results.filter(r =>
                                r.url.toLowerCase().includes(currentFilter.toLowerCase())
                            );
                        }

                        // Store results for later rendering
                        window.searchResults = filteredResults;

                        // Update stats
                        document.getElementById('searchResultsCount').textContent = filteredResults.length;
                        document.getElementById('searchTime').textContent = elapsed;
                        statsDiv.style.display = 'block';

                        if (filteredResults.length === 0) {
                            results.innerHTML = '<p class="text-muted text-center mt-4">Sin resultados para este filtro</p>';
                            return;
                        }

                        results.innerHTML = filteredResults.map((r, idx) => `
                            <div class="result-item" id="result-${idx}">
                                <div class="result-header" onclick="toggleResultContent(${idx})">
                                    <div class="result-info">
                                        <div class="result-title">${escapeHtml(r.title || 'Sin ttulo')}</div>
                                        <div class="result-url">${escapeHtml(r.url)}</div>
                                        ${r.heading_context ? `<div class="result-heading"><i class="bi bi-bookmark"></i> ${escapeHtml(r.heading_context)}</div>` : ''}
                                        <div class="result-snippet">${escapeHtml((r.chunk_content || '').substring(0, 250))}...</div>
                                        <div class="result-meta">
                                            <span class="result-score" title="Raw cosine: ${(r.raw_similarity * 100).toFixed(1)}%"><i class="bi bi-bullseye"></i> Relevancia: ${(r.similarity * 100).toFixed(0)}%</span>
                                            <span class="result-chunk-index"><i class="bi bi-layers"></i> Chunk #${r.chunk_index + 1}</span>
                                            ${r.pagerank ? `<span class="result-pagerank"><i class="bi bi-graph-up"></i> PR: ${r.pagerank.toFixed(4)}</span>` : ''}
                                        </div>
                                    </div>
                                    <button class="result-expand-btn" id="expand-btn-${idx}">
                                        <i class="bi bi-chevron-down"></i> Ver contenido
                                    </button>
                                </div>
                                <div class="result-content" id="content-${idx}">
                                    <div class="result-markdown" id="markdown-${idx}"></div>
                                    <div style="margin-top: 0.75rem;">
                                        <a href="${r.url}" target="_blank" class="btn btn-sm btn-secondary">
                                            <i class="bi bi-box-arrow-up-right"></i> Abrir pgina
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    results.innerHTML = `<p class="text-danger text-center">Error: ${error.message}</p>`;
                }
            }

            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 300);
            });

            // Filter chips - setup "Todos" static filter
            const todosChip = filtersContainer.querySelector('.filter-chip[data-filter="all"]');
            if (todosChip) {
                todosChip.addEventListener('click', () => {
                    filtersContainer.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    todosChip.classList.add('active');
                    currentFilter = 'all';
                    if (input.value.trim().length >= 2) {
                        performSearch();
                    }
                });
            }

            // Compare modal functionality
            initCompareModal();
        }

        // Text comparison functionality
        function initCompareModal() {
            const modal = document.getElementById('compareModal');
            const openBtn = document.getElementById('openCompareModal');
            const textarea = document.getElementById('compareText');
            const charCount = document.getElementById('compareCharCount');
            const runBtn = document.getElementById('runCompare');
            const resultsDiv = document.getElementById('compareResults');
            let compareMode = 'chunks';

            // Open modal
            openBtn?.addEventListener('click', () => {
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            });

            // Character count
            textarea?.addEventListener('input', () => {
                charCount.textContent = textarea.value.length;
            });

            // Mode selector
            document.querySelectorAll('.compare-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.compare-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    compareMode = btn.dataset.mode;
                });
            });

            // Run comparison
            runBtn?.addEventListener('click', async () => {
                const text = textarea.value.trim();
                if (text.length < 10) {
                    resultsDiv.innerHTML = '<p class="text-warning text-center">Introduce al menos 10 caracteres</p>';
                    return;
                }

                runBtn.disabled = true;
                runBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Buscando...';
                resultsDiv.innerHTML = '<p class="text-muted text-center">Buscando similares...</p>';

                try {
                    const clientId = document.getElementById('searchClientSelect')?.value || document.getElementById('chatClientSelect').value;

                    const response = await fetch(`${API_URL}/api/v1/dashboard/compare`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text,
                            client_id: clientId,
                            mode: compareMode,
                            top_k: 10
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.results) {
                        if (data.results.length === 0) {
                            resultsDiv.innerHTML = '<p class="text-muted text-center">No se encontraron resultados similares</p>';
                        } else {
                            resultsDiv.innerHTML = data.results.map(r => `
                                <div class="compare-result-item">
                                    <div class="compare-result-header">
                                        <div class="compare-result-title">${escapeHtml(r.title || 'Sin ttulo')}</div>
                                        <span class="compare-result-score">${(r.similarity * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="compare-result-url">${escapeHtml(r.url)}</div>
                                    <div class="compare-result-snippet">${escapeHtml((r.content || r.chunk_content || '').substring(0, 200))}...</div>
                                </div>
                            `).join('');
                        }
                    } else {
                        resultsDiv.innerHTML = `<p class="text-danger text-center">Error: ${data.detail || 'Error desconocido'}</p>`;
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<p class="text-danger text-center">Error: ${error.message}</p>`;
                }

                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="bi bi-search"></i> Buscar similares';
            });
        }

        // Parse exclude selectors from textarea (supports multiple lines)
        function parseExcludeSelectors(text) {
            if (!text || !text.trim()) return null;

            // Split by newlines, commas, or both
            const selectors = text
                .split(/[\n,]+/)
                .map(s => s.trim())
                .filter(s => s && !s.startsWith('//') && !s.startsWith('#//')); // Filter empty and comments

            return selectors.length > 0 ? selectors : null;
        }

        // Crawler functionality
        function initCrawler() {
            const startBtn = document.getElementById('startCrawl');
            const stopBtn = document.getElementById('stopCrawl');
            const log = document.getElementById('crawlLog');
            const runningIndicator = document.getElementById('crawlRunningIndicator');
            let crawlInterval;
            let elapsedInterval;
            let crawlStartTime = null;
            let recentUrls = [];
            let currentCrawlName = null;

            // Helper to format elapsed time
            function formatElapsed(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // Update elapsed time display
            function updateElapsedTime() {
                if (crawlStartTime) {
                    const elapsed = Math.floor((Date.now() - crawlStartTime) / 1000);
                    const elapsedEl = document.getElementById('crawlElapsedTime');
                    elapsedEl.textContent = formatElapsed(elapsed);
                    elapsedEl.style.display = 'inline-block';
                }
            }

            // ============================================
            // FILE UPLOAD FEEDBACK
            // ============================================
            const urlsFileInput = document.getElementById('urlsFile');
            const urlsFileFeedback = document.getElementById('urlsFileFeedback');
            const urlsFileName = document.getElementById('urlsFileName');
            const urlsFileCount = document.getElementById('urlsFileCount');
            const urlsFilePreview = document.getElementById('urlsFilePreview');
            const urlsFileClear = document.getElementById('urlsFileClear');
            let uploadedFileUrls = [];

            urlsFileInput?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) {
                    urlsFileFeedback.style.display = 'none';
                    uploadedFileUrls = [];
                    return;
                }

                try {
                    const content = await file.text();
                    const urls = content.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && !line.startsWith('#') && (line.startsWith('http://') || line.startsWith('https://')));

                    uploadedFileUrls = urls;
                    urlsFileName.textContent = file.name;
                    urlsFileCount.textContent = `${urls.length} URLs`;

                    // Show preview of first 5 URLs
                    const preview = urls.slice(0, 5).map(u => ` ${u}`).join('\n');
                    urlsFilePreview.textContent = urls.length > 5
                        ? preview + `\n... y ${urls.length - 5} ms`
                        : preview;

                    urlsFileFeedback.style.display = 'block';
                    showToast(`Archivo cargado: ${urls.length} URLs encontradas`, 'success');
                } catch (err) {
                    showToast('Error al leer el archivo', 'error');
                }
            });

            urlsFileClear?.addEventListener('click', () => {
                urlsFileInput.value = '';
                urlsFileFeedback.style.display = 'none';
                uploadedFileUrls = [];
            });

            // ============================================
            // URL LIST COUNTER
            // ============================================
            const urlsListTextarea = document.getElementById('urlsList');
            const urlsListCount = document.getElementById('urlsListCount');
            const urlsListClear = document.getElementById('urlsListClear');

            function updateUrlsListCount() {
                const text = urlsListTextarea?.value || '';
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#') && (line.startsWith('http://') || line.startsWith('https://')));

                urlsListCount.textContent = urls.length > 0
                    ? `${urls.length} URL${urls.length > 1 ? 's' : ''} en el listado`
                    : '0 URLs en el listado';

                urlsListClear.style.display = urls.length > 0 ? 'inline' : 'none';
            }

            urlsListTextarea?.addEventListener('input', updateUrlsListCount);

            urlsListClear?.addEventListener('click', (e) => {
                e.preventDefault();
                urlsListTextarea.value = '';
                updateUrlsListCount();
            });

            // ============================================
            // PHASE INDICATOR
            // ============================================
            function updatePhase(phase) {
                const phases = ['phaseInit', 'phaseSitemap', 'phaseCrawl', 'phaseComplete'];
                const phaseEl = document.getElementById('crawlPhases');
                phaseEl.style.display = 'flex';

                phases.forEach((p, i) => {
                    const el = document.getElementById(p);
                    el.classList.remove('phase-active', 'phase-complete');

                    const phaseIndex = phases.indexOf(phase);
                    if (i < phaseIndex) {
                        el.classList.add('phase-complete');
                    } else if (i === phaseIndex) {
                        el.classList.add('phase-active');
                    }
                });
            }

            // ============================================
            // RECENT URLS LIST
            // ============================================
            const recentUrlsContainer = document.getElementById('recentUrlsContainer');
            const recentUrlsList = document.getElementById('recentUrlsList');
            const toggleRecentUrls = document.getElementById('toggleRecentUrls');

            toggleRecentUrls?.addEventListener('click', () => {
                const list = document.getElementById('recentUrlsList');
                list.style.display = list.style.display === 'none' ? 'block' : 'none';
                toggleRecentUrls.querySelector('i').className =
                    list.style.display === 'none' ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
            });

            function addRecentUrl(url) {
                recentUrls.unshift(url);
                if (recentUrls.length > 10) recentUrls.pop();

                recentUrlsContainer.style.display = 'block';
                recentUrlsList.innerHTML = recentUrls.map(u =>
                    `<div class="text-truncate text-success"> ${u}</div>`
                ).join('');
            }

            // ============================================
            // LOG CONTROLS
            // ============================================
            document.getElementById('clearLog')?.addEventListener('click', () => {
                log.innerHTML = '<div class="log-entry text-muted"><i class="bi bi-info-circle"></i> Log limpiado</div>';
            });

            let logExpanded = false;
            document.getElementById('toggleLogExpand')?.addEventListener('click', () => {
                logExpanded = !logExpanded;
                log.style.maxHeight = logExpanded ? '400px' : '150px';
            });

            // ============================================
            // LINKS PREVIEW MODAL WITH FILTERS
            // ============================================
            let linksModal = null;
            let currentLinksFilter = '';

            async function loadLinksWithFilter(location = '') {
                if (!currentCrawlName) {
                    showToast('No hay crawl activo', 'warning');
                    return;
                }

                const tbody = document.getElementById('linksPreviewTable');
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Cargando...</td></tr>';

                try {
                    const url = `${API_URL}/api/v1/dashboard/crawler/crawls/${currentCrawlName}/links?limit=200${location ? `&location=${location}` : ''}`;
                    const response = await fetch(url);

                    if (response.ok) {
                        const data = await response.json();

                        // Update counts from by_location
                        const counts = data.by_location || {};
                        document.getElementById('linksTotal').textContent = data.total || 0;
                        document.getElementById('linksContent').textContent = counts.content || 0;
                        document.getElementById('linksNav').textContent = counts.nav || 0;
                        document.getElementById('linksSidebar').textContent = counts.sidebar || 0;
                        document.getElementById('linksFooter').textContent = counts.footer || 0;

                        // Update filter info
                        document.getElementById('linksShowing').textContent = data.links?.length || 0;
                        document.getElementById('linksFilteredTotal').textContent = data.filtered_total || data.total || 0;

                        // Update active tab
                        document.querySelectorAll('#linksFilterTabs button').forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.location === location) {
                                btn.classList.add('active');
                            }
                        });

                        // Populate table
                        tbody.innerHTML = data.links?.map(l => `
                            <tr>
                                <td class="text-truncate" style="max-width: 400px;" title="${l.target_url}">
                                    <a href="${l.target_url}" target="_blank" class="text-decoration-none">${l.target_url}</a>
                                </td>
                                <td class="text-truncate" style="max-width: 200px;" title="${l.anchor_text || ''}">${l.anchor_text || '<span class="text-muted">-</span>'}</td>
                                <td><span class="badge bg-${l.link_location === 'content' ? 'success' : l.link_location === 'nav' ? 'info' : l.link_location === 'footer' ? 'secondary' : 'warning'}">${l.link_location || 'content'}</span></td>
                                <td>${l.link_weight?.toFixed(2) || '1.00'}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="4" class="text-center text-muted py-4">No hay enlaces en esta categora</td></tr>';
                    }
                } catch (err) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">Error al cargar enlaces</td></tr>';
                    showToast('Error al cargar enlaces', 'error');
                }
            }

            // Open modal on click
            document.getElementById('statLinksContainer')?.addEventListener('click', async () => {
                currentLinksFilter = '';
                await loadLinksWithFilter('');
                linksModal = new bootstrap.Modal(document.getElementById('linksPreviewModal'));
                linksModal.show();
            });

            // Handle filter tab clicks
            document.getElementById('linksFilterTabs')?.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.location !== undefined) {
                    currentLinksFilter = btn.dataset.location;
                    await loadLinksWithFilter(currentLinksFilter);
                }
            });

            // Load available crawls on init
            loadAvailableCrawls();

            // Load current crawler status on init
            loadCrawlerStatus();

            async function loadCrawlerStatus() {
                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/crawler/status`);
                    const data = await response.json();

                    if (data.status === 'running') {
                        // Crawl is running, show stop button and start polling
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'block';
                        runningIndicator.style.display = 'block';
                        document.getElementById('crawlStatus').textContent = 'Crawleando...';
                        document.getElementById('crawlCurrentUrl').textContent = data.url || '';

                        // Set start time from API or now
                        if (data.started_at) {
                            crawlStartTime = new Date(data.started_at).getTime();
                        } else {
                            crawlStartTime = Date.now();
                        }
                        elapsedInterval = setInterval(updateElapsedTime, 1000);
                        updateElapsedTime();

                        crawlInterval = setInterval(updateCrawlProgress, 5000);
                        updateCrawlProgress();
                        showToast(`Crawl en progreso: ${data.url}`, 'info');
                    } else if (data.status === 'completed' || data.status === 'stopped' || data.status === 'failed') {
                        runningIndicator.style.display = 'none';
                        // Show last crawl info
                        const statusText = data.status === 'completed' ? 'Completado' :
                                          data.status === 'stopped' ? 'Detenido' : 'Error';
                        document.getElementById('crawlStatus').textContent = statusText;
                        document.getElementById('statPages').textContent = data.pages_crawled || 0;
                        document.getElementById('statLinks').textContent = data.links_found || 0;
                        document.getElementById('statErrors').textContent = data.errors || 0;

                        // Show resume info if applicable
                        if (data.resume && data.pages_previously_crawled > 0) {
                            document.getElementById('crawlPercent').textContent = 'Resume';
                            log.innerHTML = `<div class="log-entry success">[${new Date(data.completed_at).toLocaleTimeString()}] ${statusText}: ${data.pages_crawled} pginas (${data.pages_previously_crawled} previamente crawleadas)</div>`;
                        } else {
                            const percent = data.max_pages > 0 ? Math.min((data.pages_crawled / data.max_pages * 100), 100).toFixed(0) + '%' : '100%';
                            document.getElementById('crawlPercent').textContent = percent;
                            document.getElementById('crawlProgressBar').style.width = percent;
                            if (data.completed_at) {
                                log.innerHTML = `<div class="log-entry success">[${new Date(data.completed_at).toLocaleTimeString()}] ${statusText}: ${data.pages_crawled} pginas, ${data.links_found || 0} enlaces</div>`;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading crawler status:', error);
                }
            }

            // Show/hide force sitemap option based on resume checkbox
            const resumeCheckbox = document.getElementById('resumeCrawl');
            const forceSitemapGroup = document.getElementById('forceSitemapGroup');
            const forceSitemapCheckbox = document.getElementById('forceSitemap');

            resumeCheckbox.addEventListener('change', () => {
                if (resumeCheckbox.checked) {
                    forceSitemapGroup.style.display = 'block';
                } else {
                    forceSitemapGroup.style.display = 'none';
                    forceSitemapCheckbox.checked = false;
                }
            });

            startBtn.addEventListener('click', async () => {
                const url = document.getElementById('crawlUrl').value.trim();
                if (!url) {
                    showToast('Ingresa una URL vlida', 'error');
                    return;
                }

                startBtn.disabled = true;
                startBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;"></div> Iniciando...';

                // Get URLs list from textarea
                let urlsList = document.getElementById('urlsList').value.trim();

                // Check if file was uploaded and read it
                const urlsFileInput = document.getElementById('urlsFile');
                if (urlsFileInput.files.length > 0) {
                    const file = urlsFileInput.files[0];
                    const fileContent = await file.text();
                    // Append file content to existing URLs
                    if (urlsList) {
                        urlsList += '\n' + fileContent;
                    } else {
                        urlsList = fileContent;
                    }
                }

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/crawler/start`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url,
                            max_pages: parseInt(document.getElementById('crawlMaxPages').value),
                            delay: parseFloat(document.getElementById('crawlDelay').value),
                            use_sitemap: document.getElementById('useSitemap').checked,
                            content_filter: document.getElementById('contentFilter').checked,
                            resume: document.getElementById('resumeCrawl').checked,
                            force_sitemap: document.getElementById('forceSitemap').checked,
                            urls_list: urlsList,
                            urls_only: document.getElementById('urlsOnly').checked,
                            exclude_selectors: parseExcludeSelectors(document.getElementById('excludeSelectors').value),
                            respect_robots: document.getElementById('respectRobots').checked,
                            skip_noindex: document.getElementById('skipNoindex').checked,
                            sitemap_only: document.getElementById('sitemapOnly').checked
                        })
                    });

                    if (response.ok) {
                        const crawlData = await response.json();
                        showToast('Crawl iniciado correctamente', 'success');
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'block';

                        // Initialize phases
                        updatePhase('phaseInit');
                        document.getElementById('crawlPhases').style.display = 'flex';
                        document.getElementById('crawlStatus').textContent = 'Iniciando...';

                        // Reset stats
                        document.getElementById('statPages').textContent = '0';
                        document.getElementById('statLinks').textContent = '0';
                        document.getElementById('statQueue').textContent = '0';
                        document.getElementById('statErrors').textContent = '0';
                        document.getElementById('crawlProgressBar').style.width = '0%';
                        document.getElementById('crawlPercent').textContent = '0%';

                        // Clear recent URLs
                        recentUrls = [];
                        recentUrlsContainer.style.display = 'none';

                        // Extract crawl name
                        if (crawlData.output_dir) {
                            currentCrawlName = crawlData.output_dir.split('/').pop();
                        }

                        // Start elapsed timer
                        crawlStartTime = Date.now();
                        document.getElementById('crawlElapsedTime').style.display = 'inline-block';
                        elapsedInterval = setInterval(updateElapsedTime, 1000);

                        log.innerHTML = `<div class="log-entry text-info"><i class="bi bi-play-circle"></i> [${new Date().toLocaleTimeString()}] Crawl iniciado para ${url}</div>`;

                        // Poll for progress (more frequent at start)
                        crawlInterval = setInterval(updateCrawlProgress, 3000);
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Error al iniciar crawl', 'error');
                    }
                } catch (error) {
                    showToast('Error de conexin: ' + error.message, 'error');
                } finally {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="bi bi-play-fill"></i> Iniciar Crawl';
                }
            });

            stopBtn.addEventListener('click', async () => {
                try {
                    await fetch(`${API_URL}/api/v1/dashboard/crawler/stop`, { method: 'POST' });
                    clearInterval(crawlInterval);
                    clearInterval(elapsedInterval);
                    startBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                    runningIndicator.style.display = 'none';
                    document.getElementById('crawlStatus').textContent = 'Detenido';
                    showToast(' Crawl detenido', 'warning');
                    crawlStartTime = null;
                    loadAvailableCrawls();
                } catch (error) {
                    showToast('Error al detener crawl', 'error');
                }
            });

            let lastLogCount = 0;

            async function fetchCrawlerLogs() {
                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/crawler/logs?last_n=50`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.logs && data.logs.length > 0) {
                            // Only update if we have new logs
                            if (data.count !== lastLogCount) {
                                lastLogCount = data.count;
                                // Display logs in reverse order (newest at bottom for scrolling)
                                const logHtml = data.logs.map(l => {
                                    const levelClass = l.level === 'ERROR' ? 'text-danger' :
                                                      l.level === 'WARN' ? 'text-warning' :
                                                      l.level === 'OK' || l.level === 'SAVE' ? 'text-success' :
                                                      l.level === 'SKIP' ? 'text-muted' :
                                                      l.level === 'LINK' ? 'text-info' : '';
                                    return `<div class="log-entry ${levelClass}">${l.formatted || `[${l.ts}] ${l.msg}`}</div>`;
                                }).join('');
                                log.innerHTML = logHtml;
                                // Auto-scroll to bottom
                                log.scrollTop = log.scrollHeight;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching logs:', error);
                }
            }

            async function updateCrawlProgress() {
                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/crawler/status`);
                    const data = await response.json();

                    if (data.status === 'running') {
                        runningIndicator.style.display = 'block';

                        // Extract crawl name from output_dir
                        if (data.output_dir) {
                            currentCrawlName = data.output_dir.split('/').pop();
                        }

                        // Calculate progress percentage
                        let percent = 0;
                        if (data.max_pages > 0) {
                            percent = Math.min((data.pages_crawled / data.max_pages * 100), 100).toFixed(0);
                        } else {
                            // For unlimited crawls, show indeterminate or based on sitemap
                            percent = data.pages_crawled > 0 ? Math.min(data.pages_crawled, 99) : 5;
                        }

                        document.getElementById('crawlProgressBar').style.width = percent + '%';
                        document.getElementById('crawlPercent').textContent = data.max_pages > 0 ? percent + '%' : `${data.pages_crawled} pgs`;
                        document.getElementById('statPages').textContent = data.pages_crawled || 0;
                        document.getElementById('statLinks').textContent = data.links_found || 0;
                        document.getElementById('statQueue').textContent = data.queue_size || 0;
                        document.getElementById('statErrors').textContent = data.errors || 0;

                        // Update phase indicator
                        if (data.pages_crawled === 0) {
                            updatePhase('phaseInit');
                            document.getElementById('crawlStatus').textContent = 'Iniciando...';
                        } else if (data.pages_crawled < 3 && data.use_sitemap) {
                            updatePhase('phaseSitemap');
                            document.getElementById('crawlStatus').textContent = 'Descubriendo sitemap...';
                        } else {
                            updatePhase('phaseCrawl');
                            document.getElementById('crawlStatus').textContent = `Crawleando... (${data.pages_crawled}/${data.max_pages || ''})`;
                        }

                        // Update current URL and add to recent list
                        if (data.current_url) {
                            const urlEl = document.getElementById('crawlCurrentUrl');
                            if (urlEl.textContent !== data.current_url) {
                                urlEl.textContent = data.current_url;
                                addRecentUrl(data.current_url);
                            }
                        }

                        // Show secondary stats if available
                        const secondaryStats = document.getElementById('crawlSecondaryStats');
                        if (data.skipped || data.duplicates || data.robots_blocked || data.noindex_skipped) {
                            secondaryStats.style.display = 'flex';
                            document.getElementById('statSkipped').textContent = data.skipped || 0;
                            document.getElementById('statDuplicates').textContent = data.duplicates || 0;
                            document.getElementById('statRobots').textContent = data.robots_blocked || 0;
                            document.getElementById('statNoindex').textContent = data.noindex_skipped || 0;
                        }

                        // Fetch and display detailed logs
                        await fetchCrawlerLogs();
                    } else if (data.status === 'completed' || data.status === 'stopped' || data.status === 'failed') {
                        clearInterval(crawlInterval);
                        clearInterval(elapsedInterval);
                        runningIndicator.style.display = 'none';

                        // Update phase to complete
                        if (data.status === 'completed') {
                            updatePhase('phaseComplete');
                        }

                        const statusText = data.status === 'completed' ? 'Completado' : data.status === 'stopped' ? 'Detenido' : 'Error';
                        document.getElementById('crawlStatus').textContent = statusText;
                        startBtn.style.display = 'block';
                        stopBtn.style.display = 'none';

                        // Update final stats
                        document.getElementById('statPages').textContent = data.pages_crawled || 0;
                        document.getElementById('statLinks').textContent = data.links_found || 0;
                        document.getElementById('statErrors').textContent = data.errors || 0;
                        document.getElementById('statQueue').textContent = 0;

                        // Calculate elapsed time for notification
                        const elapsed = crawlStartTime ? formatElapsed(Math.floor((Date.now() - crawlStartTime) / 1000)) : '';

                        if (data.status === 'completed') {
                            showToast(` Crawl completado: ${data.pages_crawled} pginas en ${elapsed}`, 'success');
                            log.innerHTML = `<div class="log-entry success"><i class="bi bi-check-circle-fill"></i> [${new Date().toLocaleTimeString()}] Completado: ${data.pages_crawled} pginas, ${data.links_found || 0} enlaces extrados</div>` + log.innerHTML;
                        } else if (data.status === 'failed') {
                            showToast(` Error en crawl: ${data.error_message || 'Error desconocido'}`, 'error');
                            log.innerHTML = `<div class="log-entry error"><i class="bi bi-x-circle-fill"></i> [${new Date().toLocaleTimeString()}] Error: ${data.error_message || 'Error desconocido'}</div>` + log.innerHTML;
                        } else if (data.status === 'stopped') {
                            log.innerHTML = `<div class="log-entry warning"><i class="bi bi-stop-circle-fill"></i> [${new Date().toLocaleTimeString()}] Detenido manualmente: ${data.pages_crawled} pginas procesadas</div>` + log.innerHTML;
                        }

                        crawlStartTime = null;
                        loadAvailableCrawls();
                    }
                } catch (error) {
                    console.error('Error updating progress:', error);
                }
            }

            async function loadAvailableCrawls() {
                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/pipeline/status`);
                    if (response.ok) {
                        const data = await response.json();
                        window.pipelineCrawlsData = data.crawls || [];

                        // Update ingest crawl dropdown
                        const crawlSelect = document.getElementById('ingestCrawlSelect');
                        if (crawlSelect && data.crawls && data.crawls.length > 0) {
                            crawlSelect.innerHTML = '<option value="">Selecciona un crawl...</option>' +
                                data.crawls.map(c =>
                                    `<option value="${c.name}" data-path="${c.path}" data-domain="${c.domain}">${c.name} (${c.pages} pgs)${c.is_cleaned ? '  limpio' : ''}</option>`
                                ).join('');
                        }

                        // Update cleaner crawl dropdown
                        const cleanerSelect = document.getElementById('cleanerCrawlSelect');
                        if (cleanerSelect && data.crawls && data.crawls.length > 0) {
                            cleanerSelect.innerHTML = '<option value="">Selecciona un crawl...</option>' +
                                data.crawls.filter(c => c.has_html_content).map(c =>
                                    `<option value="${c.name}" data-has-html="${c.has_html_content}" data-is-cleaned="${c.is_cleaned}" data-pages="${c.pages}">${c.name} (${c.pages} pgs)${c.is_cleaned ? ' ' : ''}</option>`
                                ).join('');
                        }

                        // Update pipeline table
                        renderPipelineTable(data.crawls);
                    }
                } catch (error) {
                    console.error('Error loading crawls:', error);
                }
            }

            function renderPipelineTable(crawls) {
                const tbody = document.getElementById('crawlsPipelineBody');
                if (!tbody) return;

                if (!crawls || crawls.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                                No hay crawls disponibles. Inicia un nuevo crawl arriba.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = crawls.map(c => `
                    <tr>
                        <td>
                            <strong>${c.domain}</strong>
                            <br><small class="text-muted">${c.name}</small>
                        </td>
                        <td class="text-center">${c.pages}</td>
                        <td class="text-center">
                            ${c.has_html_content
                                ? '<span class="badge bg-success"><i class="bi bi-check"></i></span>'
                                : '<span class="badge bg-warning text-dark" title="Re-crawl requerido"><i class="bi bi-exclamation-triangle"></i></span>'}
                        </td>
                        <td class="text-center">
                            ${c.is_cleaned
                                ? '<span class="badge bg-success"><i class="bi bi-check"></i></span>'
                                : '<span class="badge bg-secondary"><i class="bi bi-dash"></i></span>'}
                        </td>
                        <td class="text-center">
                            ${c.is_ingested
                                ? '<span class="badge bg-success"><i class="bi bi-check"></i></span>'
                                : '<span class="badge bg-secondary"><i class="bi bi-dash"></i></span>'}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                ${!c.has_html_content
                                    ? `<button class="btn btn-outline-secondary" onclick="window.pipelineRecrawl('${c.domain}')" title="Re-crawl con HTML">
                                        <i class="bi bi-arrow-repeat"></i>
                                       </button>`
                                    : ''
                                }
                                ${c.has_html_content && !c.is_cleaned
                                    ? `<button class="btn btn-outline-warning" onclick="window.pipelineClean('${c.name}')" title="Limpiar HTML">
                                        <i class="bi bi-magic"></i>
                                       </button>`
                                    : ''
                                }
                                ${!c.is_ingested
                                    ? `<button class="btn btn-outline-success" onclick="window.pipelineIngest('${c.name}', '${c.path}')" title="Ir a Ingestin">
                                        <i class="bi bi-database-add"></i>
                                       </button>`
                                    : `<button class="btn btn-outline-info" onclick="window.pipelineChat('${c.domain}')" title="Ir a Chat">
                                        <i class="bi bi-chat-dots"></i>
                                       </button>`
                                }
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // Global functions for pipeline actions
            window.pipelineRecrawl = function(domain) {
                document.getElementById('crawlUrl').value = 'https://' + domain;
                showToast('URL cargada. Inicia el crawl para obtener HTML.', 'info');
            };

            window.pipelineClean = function(crawlName) {
                // Navigate to cleaner section and select crawl
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector('[data-section="cleaner"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('cleaner').classList.add('active');

                // Select the crawl in cleaner
                setTimeout(() => {
                    const select = document.getElementById('cleanerCrawlSelect');
                    if (select) {
                        select.value = crawlName;
                        select.dispatchEvent(new Event('change'));
                    }
                }, 100);
            };

            window.pipelineIngest = function(crawlName, crawlPath) {
                // Navigate to ingest section and select crawl
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector('[data-section="ingest"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('ingest').classList.add('active');

                // Select the crawl in ingest
                setTimeout(() => {
                    const select = document.getElementById('ingestCrawlSelect');
                    if (select) {
                        select.value = crawlName;
                        select.dispatchEvent(new Event('change'));
                    }
                }, 100);
            };

            window.pipelineChat = function(domain) {
                // Navigate to chat section
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector('[data-section="chat"]').classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('chat').classList.add('active');
                showToast(`Chat listo para ${domain}`, 'success');
            };

            // Refresh button
            document.getElementById('refreshCrawlsList')?.addEventListener('click', loadAvailableCrawls);
        }

        // Ingestion functionality
        function initIngest() {
            const crawlSelect = document.getElementById('ingestCrawlSelect');
            const searchFilter = document.getElementById('ingestSearchFilter');
            const minWordsFilter = document.getElementById('ingestMinWords');
            const selectAllCheckbox = document.getElementById('ingestSelectAll');
            const documentList = document.getElementById('ingestDocumentList');
            const startBtn = document.getElementById('startIngest');
            const statusDiv = document.getElementById('ingestStatus');
            // Preview modal
            const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));

            let currentCrawl = null;
            let currentPage = 0;
            const pageSize = 50;
            let selectedUrls = new Set();
            let allFilteredUrls = [];

            // Load available crawls
            loadCrawlsForIngest();

            async function loadCrawlsForIngest() {
                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/crawler/crawls`);
                    if (response.ok) {
                        const data = await response.json();
                        crawlSelect.innerHTML = '<option value="">Selecciona un crawl...</option>' +
                            data.crawls.map(c => `<option value="${c.name}" data-path="${c.path}" data-pages="${c.pages}">${c.name.replace(/_/g, '.')} (${c.pages} pgs)</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading crawls:', error);
                }
            }

            // Crawl selection change
            crawlSelect.addEventListener('change', async () => {
                const selected = crawlSelect.options[crawlSelect.selectedIndex];
                if (!selected.value) {
                    currentCrawl = null;
                    document.getElementById('ingestFilters').style.display = 'none';
                    document.getElementById('ingestStats').style.display = 'none';
                    document.getElementById('ingestPagination').style.display = 'none';
                    document.getElementById('deleteCrawlBtn').style.display = 'none';
                    documentList.innerHTML = `<p class="text-muted text-center py-4">
                        <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i><br>
                        Selecciona un crawl para ver los documentos disponibles
                    </p>`;
                    startBtn.disabled = true;
                    return;
                }

                currentCrawl = selected.value;
                document.getElementById('ingestPath').value = selected.dataset.path || '';

                // Auto-fill client name and domain from data attributes or derive from value
                const domain = selected.dataset.domain || selected.value.replace(/_/g, '.');
                const clientName = domain.replace(/^www\./, '').split('.')[0];
                document.getElementById('ingestClientName').value = clientName.charAt(0).toUpperCase() + clientName.slice(1);
                document.getElementById('ingestDomain').value = domain;

                document.getElementById('ingestFilters').style.display = 'flex';
                document.getElementById('ingestStats').style.display = 'block';
                document.getElementById('deleteCrawlBtn').style.display = 'inline-block';

                currentPage = 0;
                selectedUrls.clear();
                loadDocuments();
            });

            // Filter changes
            let searchTimeout;
            searchFilter.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 0;
                    loadDocuments();
                }, 300);
            });

            minWordsFilter.addEventListener('change', () => {
                currentPage = 0;
                loadDocuments();
            });

            // Select all
            selectAllCheckbox.addEventListener('change', () => {
                if (selectAllCheckbox.checked) {
                    allFilteredUrls.forEach(url => selectedUrls.add(url));
                } else {
                    selectedUrls.clear();
                }
                updateSelectionUI();
                updateStartButton();
            });

            // Load documents from API
            async function loadDocuments() {
                if (!currentCrawl) return;

                documentList.innerHTML = '<div class="text-center py-4"><div class="spinner"></div> Cargando documentos...</div>';

                try {
                    const search = searchFilter.value.trim();
                    const minWords = parseInt(minWordsFilter.value) || 0;
                    const url = `${API_URL}/api/v1/dashboard/crawler/crawls/${currentCrawl}/pages?limit=${pageSize}&offset=${currentPage * pageSize}&min_words=${minWords}${search ? `&search=${encodeURIComponent(search)}` : ''}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Error loading pages');

                    const data = await response.json();

                    // Update stats
                    document.getElementById('ingestTotalPages').textContent = data.total;
                    document.getElementById('ingestFilteredPages').textContent = data.filtered;

                    // Store filtered URLs for select all
                    if (currentPage === 0) {
                        allFilteredUrls = data.pages.map(p => p.url);
                    }

                    // Render documents
                    if (data.pages.length === 0) {
                        documentList.innerHTML = '<p class="text-muted text-center py-4">No se encontraron documentos con estos filtros</p>';
                    } else {
                        documentList.innerHTML = data.pages.map(page => `
                            <div class="document-item" data-url="${page.url}" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;">
                                <div class="d-flex align-items-start gap-2">
                                    <input type="checkbox" class="form-check-input doc-checkbox" data-url="${page.url}" ${selectedUrls.has(page.url) ? 'checked' : ''} style="margin-top: 0.25rem;">
                                    <div class="flex-grow-1" style="min-width: 0;">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <strong class="text-truncate d-block" style="max-width: 80%;">${page.title || 'Sin ttulo'}</strong>
                                            <span class="badge ${page.word_count >= 100 ? 'bg-success' : page.word_count >= 50 ? 'bg-warning' : 'bg-danger'}" style="font-size: 0.7rem;">${page.word_count} palabras</span>
                                        </div>
                                        <small class="text-muted text-truncate d-block">${page.url}</small>
                                        <small class="text-secondary" style="font-size: 0.75rem;">${page.content_preview}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary preview-btn" data-url="${page.url}" title="Ver contenido">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger delete-btn" data-url="${page.url}" title="Eliminar documento">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');

                        // Add event listeners
                        documentList.querySelectorAll('.doc-checkbox').forEach(cb => {
                            cb.addEventListener('change', (e) => {
                                e.stopPropagation();
                                const url = cb.dataset.url;
                                if (cb.checked) {
                                    selectedUrls.add(url);
                                } else {
                                    selectedUrls.delete(url);
                                }
                                updateSelectionUI();
                                updateStartButton();
                            });
                        });

                        documentList.querySelectorAll('.document-item').forEach(item => {
                            item.addEventListener('click', (e) => {
                                if (e.target.closest('.doc-checkbox') || e.target.closest('.preview-btn') || e.target.closest('.delete-btn')) return;
                                const cb = item.querySelector('.doc-checkbox');
                                cb.checked = !cb.checked;
                                cb.dispatchEvent(new Event('change'));
                            });
                        });

                        documentList.querySelectorAll('.preview-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showPreview(btn.dataset.url);
                            });
                        });

                        documentList.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                deleteDocument(btn.dataset.url);
                            });
                        });
                    }

                    // Update pagination
                    const totalPages = Math.ceil(data.filtered / pageSize);
                    document.getElementById('ingestPagination').style.display = totalPages > 1 ? 'flex' : 'none';
                    document.getElementById('ingestPageInfo').textContent = `Pgina ${currentPage + 1} de ${totalPages}`;
                    document.getElementById('ingestPrevPage').disabled = currentPage === 0;
                    document.getElementById('ingestNextPage').disabled = currentPage >= totalPages - 1;

                    updateStartButton();

                } catch (error) {
                    console.error('Error:', error);
                    documentList.innerHTML = `<p class="text-danger text-center py-4"><i class="bi bi-x-circle"></i> Error cargando documentos</p>`;
                }
            }

            function updateSelectionUI() {
                document.getElementById('ingestSelectedPages').textContent = selectedUrls.size;
                documentList.querySelectorAll('.doc-checkbox').forEach(cb => {
                    cb.checked = selectedUrls.has(cb.dataset.url);
                });
                // Show/hide delete selected button
                const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                deleteSelectedBtn.style.display = selectedUrls.size > 0 ? 'inline-block' : 'none';
            }

            function updateStartButton() {
                const clientName = document.getElementById('ingestClientName').value.trim();
                const domain = document.getElementById('ingestDomain').value.trim();
                startBtn.disabled = !currentCrawl || !clientName || !domain;
            }

            // Input changes enable button
            document.getElementById('ingestClientName').addEventListener('input', updateStartButton);
            document.getElementById('ingestDomain').addEventListener('input', updateStartButton);

            // Pagination
            document.getElementById('ingestPrevPage').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadDocuments();
                }
            });

            document.getElementById('ingestNextPage').addEventListener('click', () => {
                currentPage++;
                loadDocuments();
            });

            // Preview functionality - Abre modal emergente grande
            async function showPreview(url) {
                // Mostrar modal con spinner de carga
                document.getElementById('previewContent').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-muted">Cargando contenido...</p>
                    </div>
                `;
                document.getElementById('previewTitle').textContent = 'Cargando...';
                document.getElementById('previewUrl').textContent = url;
                document.getElementById('previewWords').textContent = '...';
                document.getElementById('previewOpenUrl').href = url;
                previewModal.show();

                // Force fullscreen modal styles with position: fixed
                setTimeout(() => {
                    const modalEl = document.getElementById('previewModal');
                    const dialogEl = modalEl.querySelector('.modal-dialog');
                    const contentEl = modalEl.querySelector('.modal-content');
                    const bodyEl = modalEl.querySelector('.modal-body');
                    const headerEl = modalEl.querySelector('.modal-header');
                    const previewContent = modalEl.querySelector('.preview-content');
                    if (dialogEl) {
                        dialogEl.style.setProperty('position', 'fixed', 'important');
                        dialogEl.style.setProperty('top', '0', 'important');
                        dialogEl.style.setProperty('left', '0', 'important');
                        dialogEl.style.setProperty('right', '0', 'important');
                        dialogEl.style.setProperty('bottom', '0', 'important');
                        dialogEl.style.setProperty('width', '100vw', 'important');
                        dialogEl.style.setProperty('max-width', '100vw', 'important');
                        dialogEl.style.setProperty('height', '100vh', 'important');
                        dialogEl.style.setProperty('margin', '0', 'important');
                        dialogEl.style.setProperty('transform', 'none', 'important');
                    }
                    if (contentEl) {
                        contentEl.style.setProperty('height', '100vh', 'important');
                        contentEl.style.setProperty('border', 'none', 'important');
                        contentEl.style.setProperty('border-radius', '0', 'important');
                        contentEl.style.setProperty('background', '#ffffff', 'important');
                    }
                    if (bodyEl) {
                        bodyEl.style.setProperty('background', '#ffffff', 'important');
                    }
                    if (headerEl) {
                        headerEl.style.setProperty('background', '#f8f9fa', 'important');
                    }
                    if (previewContent) {
                        previewContent.style.setProperty('background', '#ffffff', 'important');
                        previewContent.style.setProperty('box-shadow', 'none', 'important');
                        previewContent.style.setProperty('border', 'none', 'important');
                    }
                }, 50);

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/crawler/crawls/${currentCrawl}/page?url=${encodeURIComponent(url)}`);
                    if (!response.ok) throw new Error('Page not found');

                    const data = await response.json();
                    document.getElementById('previewTitle').textContent = data.title || 'Sin ttulo';
                    document.getElementById('previewUrl').textContent = data.url;

                    // Show cleaned badge if content is cleaned
                    const cleanedBadge = data.is_cleaned
                        ? `<span class="badge bg-success me-2"><i class="bi bi-magic"></i> Limpio</span>`
                        : `<span class="badge bg-secondary me-2"><i class="bi bi-file-text"></i> Raw</span>`;
                    const templateInfo = data.template_group
                        ? `<span class="badge bg-info">${data.template_group}</span>`
                        : '';
                    document.getElementById('previewWords').innerHTML = `${cleanedBadge}${templateInfo} ${data.word_count} palabras`;

                    document.getElementById('previewOpenUrl').href = data.url;

                    // Both cleaned and raw content are now Markdown - parse with marked.js
                    const content = data.markdown || 'Sin contenido';
                    document.getElementById('previewContent').innerHTML = marked.parse(content);
                } catch (error) {
                    document.getElementById('previewContent').innerHTML = `
                        <div class="text-center py-5 text-danger">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                            <p class="mt-3">Error cargando el contenido del documento</p>
                        </div>
                    `;
                }
            }

            // Delete single document
            async function deleteDocument(url) {
                if (!confirm(`Ests seguro de que quieres eliminar este documento?\n\n${url}`)) {
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/crawler/crawls/${currentCrawl}/page?url=${encodeURIComponent(url)}`,
                        { method: 'DELETE' }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        showToast(`Documento eliminado correctamente`, 'success');
                        // Reload document list
                        loadDocuments(currentPage);
                    } else {
                        const error = await response.json();
                        showToast(`Error: ${error.detail || 'No se pudo eliminar'}`, 'error');
                    }
                } catch (error) {
                    showToast(`Error de conexin: ${error.message}`, 'error');
                }
            }

            // Delete selected documents
            async function deleteSelectedDocuments() {
                const selectedUrls = getSelectedUrls();
                if (selectedUrls.length === 0) {
                    showToast('No hay documentos seleccionados', 'warning');
                    return;
                }

                if (!confirm(`Ests seguro de que quieres eliminar ${selectedUrls.length} documentos seleccionados?`)) {
                    return;
                }

                const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                deleteSelectedBtn.disabled = true;
                deleteSelectedBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Eliminando...';

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/crawler/crawls/${currentCrawl}/delete-pages`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ urls: selectedUrls })
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        showToast(`${data.deleted} documentos eliminados`, 'success');
                        // Reload document list
                        loadDocuments(1);
                    } else {
                        const error = await response.json();
                        showToast(`Error: ${error.detail || 'No se pudo eliminar'}`, 'error');
                    }
                } catch (error) {
                    showToast(`Error de conexin: ${error.message}`, 'error');
                } finally {
                    deleteSelectedBtn.disabled = false;
                    deleteSelectedBtn.innerHTML = '<i class="bi bi-trash"></i> Eliminar seleccionadas';
                }
            }

            // Delete entire crawl
            async function deleteCrawl() {
                if (!currentCrawl) return;

                if (!confirm(`Ests seguro de que quieres eliminar TODO el crawl "${currentCrawl}"?\n\nEsta accin eliminar todos los documentos y no se puede deshacer.`)) {
                    return;
                }

                // Second confirmation for safety
                if (!confirm(`CONFIRMAR: Se eliminarn TODOS los documentos del crawl "${currentCrawl}". Continuar?`)) {
                    return;
                }

                const deleteCrawlBtn = document.getElementById('deleteCrawlBtn');
                deleteCrawlBtn.disabled = true;
                deleteCrawlBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Eliminando...';

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/crawler/crawls/${currentCrawl}`,
                        { method: 'DELETE' }
                    );

                    if (response.ok) {
                        showToast(`Crawl "${currentCrawl}" eliminado correctamente`, 'success');
                        // Reset UI
                        currentCrawl = null;
                        crawlSelect.value = '';
                        document.getElementById('ingestFilters').style.display = 'none';
                        document.getElementById('ingestStats').style.display = 'none';
                        deleteCrawlBtn.style.display = 'none';
                        documentList.innerHTML = `
                            <p class="text-muted text-center py-4">
                                <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i><br>
                                Selecciona un crawl para ver los documentos disponibles
                            </p>
                        `;
                        // Reload crawl list
                        loadCrawls();
                    } else {
                        const error = await response.json();
                        showToast(`Error: ${error.detail || 'No se pudo eliminar'}`, 'error');
                    }
                } catch (error) {
                    showToast(`Error de conexin: ${error.message}`, 'error');
                } finally {
                    deleteCrawlBtn.disabled = false;
                    deleteCrawlBtn.innerHTML = '<i class="bi bi-trash"></i> Eliminar Crawl';
                }
            }

            // Helper to get selected URLs
            function getSelectedUrls() {
                const checkboxes = documentList.querySelectorAll('.doc-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.dataset.url);
            }

            // Setup delete buttons event listeners
            document.getElementById('deleteCrawlBtn').addEventListener('click', deleteCrawl);
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedDocuments);

            // Start ingestion
            startBtn.addEventListener('click', async () => {
                const path = document.getElementById('ingestPath').value.trim();
                const clientName = document.getElementById('ingestClientName').value.trim();
                const domain = document.getElementById('ingestDomain').value.trim();

                if (!path || !clientName || !domain) {
                    showToast('Completa todos los campos requeridos', 'error');
                    return;
                }

                startBtn.disabled = true;
                startBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;"></div> Procesando...';
                statusDiv.innerHTML = '<p class="text-warning"><i class="bi bi-hourglass-split"></i> Procesando datos... Esto puede tardar varios minutos.</p>';

                try {
                    const embeddingSelect = document.getElementById('ingestEmbeddingModel');
                    const embeddingModel = embeddingSelect?.value || 'hiiamsid/sentence_similarity_spanish_es';
                    const embeddingDim = parseInt(embeddingSelect?.selectedOptions[0]?.dataset?.dim) || 768;

                    const response = await fetch(`${API_URL}/api/v1/dashboard/ingest`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            crawl_path: path,
                            client_name: clientName,
                            client_domain: domain,
                            ingest_mode: document.getElementById('ingestMode')?.value || 'new_only',
                            min_word_count: parseInt(document.getElementById('ingestMinWordCount')?.value) || 50,
                            delete_after: document.getElementById('deleteAfterIngest')?.checked || false,
                            embedding_model: embeddingModel,
                            embedding_dimension: embeddingDim
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        showToast(`Ingestin completada: ${data.pages_migrated} pginas`);
                        const modelShort = data.embedding_model?.split('/').pop() || 'default';
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle"></i> Completado</h6>
                                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.25rem; font-size: 0.85rem;">
                                    <li>Pginas nuevas: ${data.pages_migrated}</li>
                                    ${data.pages_skipped > 0 ? `<li>Saltadas: ${data.pages_skipped}</li>` : ''}
                                    <li>Chunks: ${data.chunks_created || 0}</li>
                                    <li>Embeddings: ${data.embeddings_generated}</li>
                                    <li>Enlaces: ${data.links_migrated}</li>
                                    <li>Modelo: ${modelShort} (${data.embedding_dimension}d)</li>
                                    ${data.errors > 0 ? `<li class="text-warning">Errores: ${data.errors}</li>` : ''}
                                </ul>
                            </div>
                        `;
                        loadClients();
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Error en la ingestin', 'error');
                        statusDiv.innerHTML = `<p class="text-danger"><i class="bi bi-x-circle"></i> ${error.detail || 'Error'}</p>`;
                    }
                } catch (error) {
                    showToast('Error de conexin', 'error');
                    statusDiv.innerHTML = `<p class="text-danger"><i class="bi bi-x-circle"></i> Error de conexin</p>`;
                } finally {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="bi bi-database-add"></i> Iniciar Ingestin';
                }
            });
        }

        // Manual Cleaner functionality
        function initCleaner() {
            // State
            let currentCrawl = null;
            let currentTemplateId = null;
            let currentSampleIndex = 0;
            let totalSamples = 0;
            let currentPatterns = [];

            // DOM Elements
            const step1 = document.getElementById('cleanerStep1');
            const step2 = document.getElementById('cleanerStep2');
            const step3 = document.getElementById('cleanerStep3');
            const crawlsList = document.getElementById('cleanerCrawlsList');
            const templatesList = document.getElementById('cleanerTemplatesList');
            const refreshBtn = document.getElementById('refreshCleanerCrawls');
            const backToCrawlsBtn = document.getElementById('backToCrawls');
            const backToTemplatesBtn = document.getElementById('backToTemplates');
            const patternValue = document.getElementById('patternValue');
            const patternValueEnd = document.getElementById('patternValueEnd');
            const patternEndContainer = document.getElementById('patternEndContainer');
            const addPatternBtn = document.getElementById('addPatternBtn');
            const patternsList = document.getElementById('patternsList');
            const prevSampleBtn = document.getElementById('prevSampleBtn');
            const nextSampleBtn = document.getElementById('nextSampleBtn');
            const previewCleaningBtn = document.getElementById('previewCleaningBtn');
            const applyCleaningBtn = document.getElementById('applyCleaningBtn');
            const markdownOriginalEl = document.getElementById('markdownOriginal');

            // Helper to get selected pattern type from radio buttons
            const getSelectedPatternType = () => {
                const selected = document.querySelector('input[name="patternType"]:checked');
                return selected ? selected.value : 'contains';
            };

            // Initialize
            loadCrawls();

            // Pattern type change handler (radio buttons)
            document.querySelectorAll('input[name="patternType"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const type = getSelectedPatternType();
                    patternEndContainer.style.display = (type === 'line_range' || type === 'text_range') ? 'block' : 'none';
                });
            });

            // Auto-clean toggle handler
            const enableAutoClean = document.getElementById('enableAutoClean');
            const autoCleanOptions = document.getElementById('autoCleanOptions');
            if (enableAutoClean && autoCleanOptions) {
                enableAutoClean.addEventListener('change', () => {
                    autoCleanOptions.style.opacity = enableAutoClean.checked ? '1' : '0.5';
                    autoCleanOptions.querySelectorAll('input').forEach(cb => {
                        cb.disabled = !enableAutoClean.checked;
                    });
                });
            }

            // Text selection handler - when user selects text in the original panel
            markdownOriginalEl.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                if (selectedText && selectedText.length > 0) {
                    // Put the selected text in the pattern input
                    patternValue.value = selectedText;
                    patternValue.focus();

                    // Auto-select pattern type based on content
                    if (selectedText.includes('\n') || selectedText.length > 100) {
                        // Multi-line or long selection -> exact (remove whole block)
                        document.getElementById('pt_exact').checked = true;
                    } else if (selectedText.length < 50) {
                        // Short single line -> exact
                        document.getElementById('pt_exact').checked = true;
                    } else {
                        // Long single line -> contains
                        document.getElementById('pt_contains').checked = true;
                    }

                    // Auto-expand textarea height based on content
                    autoExpandTextarea(patternValue);
                    updateCharCount(patternValue);

                    // Show visual feedback
                    patternValue.classList.add('border-success');
                    setTimeout(() => patternValue.classList.remove('border-success'), 1000);
                }
            });

            // Auto-expand textarea and show char count
            function autoExpandTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
            }

            function updateCharCount(textarea) {
                const charCount = document.getElementById('patternCharCount');
                const len = textarea.value.length;
                const lines = textarea.value.split('\n').length;
                if (len > 0) {
                    charCount.textContent = `${len} caracteres, ${lines} lineas`;
                } else {
                    charCount.textContent = '';
                }
            }

            patternValue.addEventListener('input', () => {
                autoExpandTextarea(patternValue);
                updateCharCount(patternValue);
            });

            // Refresh button
            refreshBtn.addEventListener('click', loadCrawls);

            // Back buttons
            backToCrawlsBtn.addEventListener('click', () => {
                step2.style.display = 'none';
                step1.style.display = 'block';
                currentCrawl = null;
                updateBreadcrumb(1);
            });

            backToTemplatesBtn.addEventListener('click', () => {
                step3.style.display = 'none';
                step2.style.display = 'block';
                currentTemplateId = null;
                updateBreadcrumb(2, currentCrawl ? currentCrawl.replace(/_/g, '.') : '');
            });

            // Auto-clean ALL pages button
            const autoCleanAllBtn = document.getElementById('autoCleanAllBtn');
            autoCleanAllBtn.addEventListener('click', async () => {
                if (!currentCrawl) {
                    showToast('Selecciona un crawl primero', 'warning');
                    return;
                }

                if (!confirm(`Aplicar auto-limpieza a TODAS las pginas de ${currentCrawl}?`)) {
                    return;
                }

                autoCleanAllBtn.disabled = true;
                autoCleanAllBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

                try {
                    const options = {
                        extract_from_first_heading: document.getElementById('acAllHeading')?.checked ?? true,
                        remove_footer_content: document.getElementById('acAllFooter')?.checked ?? true,
                        remove_nav_patterns: document.getElementById('acAllNav')?.checked ?? true,
                        remove_empty_lines: true,
                        min_heading_level: 1
                    };

                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/auto-clean/${currentCrawl}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(options)
                        }
                    );

                    if (!response.ok) throw new Error('Error en auto-limpieza');

                    const data = await response.json();
                    showToast(`Auto-limpieza aplicada: ${data.pages_cleaned} pginas procesadas`, 'success');

                    // Show status
                    const statusDiv = document.getElementById('autoCleanStatus');
                    const statsSpan = document.getElementById('autoCleanStats');
                    if (statusDiv && statsSpan) {
                        statusDiv.style.display = 'block';
                        statsSpan.textContent = `${data.pages_cleaned} pgs | ${data.reduction_pct}% reduccin`;
                    }

                    // Refresh templates list
                    window.selectCrawlForCleaning(currentCrawl);

                } catch (error) {
                    console.error('Error auto-cleaning:', error);
                    showToast('Error en auto-limpieza: ' + error.message, 'error');
                } finally {
                    autoCleanAllBtn.disabled = false;
                    autoCleanAllBtn.innerHTML = '<i class="bi bi-lightning"></i> Aplicar';
                }
            });

            // Sample navigation
            prevSampleBtn.addEventListener('click', () => {
                if (currentSampleIndex > 0) {
                    currentSampleIndex--;
                    loadTemplateSample();
                }
            });

            nextSampleBtn.addEventListener('click', () => {
                if (currentSampleIndex < totalSamples - 1) {
                    currentSampleIndex++;
                    loadTemplateSample();
                }
            });

            // Add pattern
            addPatternBtn.addEventListener('click', addPattern);

            // Preview and Apply buttons
            previewCleaningBtn.addEventListener('click', previewCleaning);
            applyCleaningBtn.addEventListener('click', applyCleaning);

            // Load available crawls
            // Update breadcrumb navigation
            function updateBreadcrumb(step, crawlName = '', templateId = '') {
                const breadcrumb = document.getElementById('cleanerBreadcrumb');
                if (!breadcrumb) return;

                let html = '';
                if (step === 1) {
                    html = `<li class="breadcrumb-item active"><i class="bi bi-folder2"></i> Crawls</li>`;
                } else if (step === 2) {
                    html = `
                        <li class="breadcrumb-item"><a href="#" onclick="event.preventDefault(); document.getElementById('backToCrawls').click();"><i class="bi bi-folder2"></i> Crawls</a></li>
                        <li class="breadcrumb-item active"><i class="bi bi-layers"></i> ${crawlName}</li>
                    `;
                } else if (step === 3) {
                    html = `
                        <li class="breadcrumb-item"><a href="#" onclick="event.preventDefault(); document.getElementById('backToCrawls').click();"><i class="bi bi-folder2"></i> Crawls</a></li>
                        <li class="breadcrumb-item"><a href="#" onclick="event.preventDefault(); document.getElementById('backToTemplates').click();"><i class="bi bi-layers"></i> ${crawlName}</a></li>
                        <li class="breadcrumb-item active"><i class="bi bi-pencil-square"></i> ${templateId}</li>
                    `;
                }
                breadcrumb.innerHTML = html;
            }

            async function loadCrawls() {
                crawlsList.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm"></div>
                        <span class="ms-2 text-muted small">Cargando crawls...</span>
                    </div>
                `;

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/cleaner/crawls`);
                    if (!response.ok) throw new Error('Error loading crawls');

                    const data = await response.json();

                    if (data.crawls.length === 0) {
                        crawlsList.innerHTML = `
                            <div class="text-muted text-center py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                                No hay crawls disponibles.<br>
                                <small>Primero usa el Crawler para extraer contenido.</small>
                            </div>
                        `;
                        return;
                    }

                    // Render crawls as compact table
                    crawlsList.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Dominio</th>
                                        <th class="text-center">Pginas</th>
                                        <th class="text-center">Estado</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.crawls.map(c => `
                                        <tr class="crawl-row" style="cursor: pointer;" onclick="window.selectCrawlForCleaning('${c.name}')">
                                            <td>
                                                <i class="bi bi-globe text-muted me-1"></i>
                                                <strong>${c.name.replace(/_/g, '.')}</strong>
                                            </td>
                                            <td class="text-center"><span class="badge bg-secondary">${c.pages}</span></td>
                                            <td class="text-center">
                                                ${c.has_html_content
                                                    ? '<span class="badge bg-success"><i class="bi bi-check"></i> HTML</span>'
                                                    : '<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i></span>'}
                                                ${c.is_cleaned
                                                    ? '<span class="badge bg-info ms-1"><i class="bi bi-sparkles"></i></span>'
                                                    : ''}
                                            </td>
                                            <td class="text-end">
                                                <i class="bi bi-chevron-right text-muted"></i>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;

                    updateBreadcrumb(1);

                } catch (error) {
                    console.error('Error loading cleaner crawls:', error);
                    crawlsList.innerHTML = `
                        <div class="text-danger text-center py-4">
                            <i class="bi bi-x-circle"></i> Error cargando crawls
                        </div>
                    `;
                }
            }

            // Store templates data for preview
            let templatesData = [];

            // Expose selectCrawl globally
            window.selectCrawlForCleaning = async function(crawlName) {
                currentCrawl = crawlName;
                document.getElementById('cleanerCrawlName').textContent = crawlName.replace(/_/g, '.');

                // Show step 2 and hide step 1
                step1.style.display = 'none';
                step2.style.display = 'block';

                // Update breadcrumb
                updateBreadcrumb(2, crawlName.replace(/_/g, '.'));

                // Reset preview area
                const previewArea = document.getElementById('templatePreviewArea');
                previewArea.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-hand-index" style="font-size: 2rem;"></i>
                        <p class="mt-2">Selecciona una plantilla para ver una muestra</p>
                    </div>
                `;

                // Load templates
                templatesList.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm"></div>
                        <p class="mt-2 text-muted small">Analizando plantillas HTML...</p>
                    </div>
                `;

                try {
                    // Check auto-clean status first
                    const statusResponse = await fetch(`${API_URL}/api/v1/dashboard/manual-cleaner/status/${crawlName}`);
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        const statusDiv = document.getElementById('autoCleanStatus');
                        const statsSpan = document.getElementById('autoCleanStats');
                        if (statusDiv && statusData.auto_clean && statusData.auto_clean.applied) {
                            statusDiv.style.display = 'block';
                            statsSpan.textContent = `${statusData.auto_clean.pages} pgs | ${statusData.auto_clean.reduction_pct}% reduccin`;
                        } else if (statusDiv) {
                            statusDiv.style.display = 'none';
                        }
                    }

                    const response = await fetch(`${API_URL}/api/v1/dashboard/manual-cleaner/analyze/${crawlName}`);
                    if (!response.ok) throw new Error('Error analyzing templates');

                    const data = await response.json();
                    templatesData = data.templates;

                    if (data.templates.length === 0) {
                        templatesList.innerHTML = `
                            <p class="text-muted text-center py-4">
                                No se detectaron plantillas.
                            </p>
                        `;
                        return;
                    }

                    // Render templates as list items
                    templatesList.innerHTML = data.templates.map((t, idx) => `
                        <div class="template-item p-2 border-bottom" style="cursor: pointer; transition: all 0.15s;"
                             data-template-id="${t.template_id}" data-index="${idx}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <code class="text-primary small">${t.path_pattern || t.fingerprint}</code>
                                    <span class="badge bg-light text-dark ms-1">${t.page_count}</span>
                                </div>
                                <div class="d-flex gap-1 align-items-center">
                                    ${t.patterns_count > 0
                                        ? `<span class="badge bg-success" title="${t.patterns_count} patrones"><i class="bi bi-filter"></i></span>`
                                        : ''}
                                    ${t.is_cleaned
                                        ? '<span class="badge bg-info" title="Limpiado"><i class="bi bi-check-circle"></i></span>'
                                        : '<span class="badge bg-secondary" title="Pendiente"><i class="bi bi-clock"></i></span>'}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // Add hover and click handlers
                    templatesList.querySelectorAll('.template-item').forEach(item => {
                        // Hover: show preview
                        item.addEventListener('mouseenter', function() {
                            this.style.background = 'var(--bg-hover, #f8f9fa)';
                            const idx = parseInt(this.dataset.index);
                            showTemplatePreview(templatesData[idx]);
                        });
                        item.addEventListener('mouseleave', function() {
                            this.style.background = '';
                        });
                        // Click: go to editor
                        item.addEventListener('click', function() {
                            const templateId = this.dataset.templateId;
                            console.log('Selecting template:', templateId);
                            window.selectTemplateForCleaning(templateId);
                        });
                    });

                } catch (error) {
                    console.error('Error analyzing templates:', error);
                    templatesList.innerHTML = `
                        <p class="text-danger text-center py-4">
                            <i class="bi bi-x-circle"></i> Error analizando plantillas
                        </p>
                    `;
                }
            };

            // Show template preview in right panel
            function showTemplatePreview(template) {
                const previewArea = document.getElementById('templatePreviewArea');
                if (!previewArea || !template) return;

                previewArea.innerHTML = `
                    <div class="h-100 d-flex flex-column">
                        <div class="mb-3">
                            <h6 class="mb-2">
                                <i class="bi bi-folder"></i> URL Pattern:
                                <code class="text-primary">${template.path_pattern || template.fingerprint}</code>
                            </h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="border rounded p-2">
                                        <h5 class="mb-0">${template.page_count}</h5>
                                        <small class="text-muted">Pginas</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-2">
                                        <h5 class="mb-0">${template.patterns_count}</h5>
                                        <small class="text-muted">Patrones</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-2">
                                        <h5 class="mb-0 ${template.is_cleaned ? 'text-success' : 'text-warning'}">
                                            ${template.is_cleaned ? '<i class="bi bi-check"></i>' : '<i class="bi bi-dash"></i>'}
                                        </h5>
                                        <small class="text-muted">Estado</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-2"><i class="bi bi-link-45deg"></i> URLs de ejemplo:</h6>
                            <ul class="list-unstyled small" style="max-height: 300px; overflow-y: auto;">
                                ${template.sample_urls.map(url => `
                                    <li class="text-truncate mb-1">
                                        <i class="bi bi-file-earmark text-muted"></i>
                                        <a href="${url}" target="_blank" class="text-decoration-none">${url}</a>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="mt-auto pt-3">
                            <button class="btn btn-primary w-100" onclick="window.selectTemplateForCleaning('${template.template_id}')">
                                <i class="bi bi-pencil-square"></i> Editar esta plantilla
                            </button>
                        </div>
                    </div>
                `;
            }

            // Expose selectTemplate globally
            window.selectTemplateForCleaning = async function(templateId) {
                console.log('selectTemplateForCleaning called with:', templateId, 'current crawl:', currentCrawl);

                if (!templateId) {
                    console.error('No templateId provided!');
                    showToast('Error: plantilla no vlida', 'error');
                    return;
                }

                currentTemplateId = templateId;
                currentSampleIndex = 0;

                // Show step 3 and hide step 2
                step2.style.display = 'none';
                step3.style.display = 'block';

                // Update breadcrumb
                updateBreadcrumb(3, currentCrawl.replace(/_/g, '.'), templateId);

                // Update template info
                document.getElementById('editorTemplateId').textContent = templateId;

                // Load sample
                await loadTemplateSample();
            };

            // Load template sample
            async function loadTemplateSample() {
                // Guard: don't fetch if template is not selected
                if (!currentCrawl || !currentTemplateId) {
                    console.warn('loadTemplateSample called without valid crawl/template');
                    return;
                }

                const url = `${API_URL}/api/v1/dashboard/manual-cleaner/template/${currentCrawl}/${currentTemplateId}?sample_index=${currentSampleIndex}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error:', response.status, errorText);
                        throw new Error('Error loading sample');
                    }

                    const data = await response.json();
                    console.log('Sample data received:', data);

                    // Update sample info
                    totalSamples = data.total_samples;
                    currentPatterns = data.patterns || [];

                    // Helper function to safely set element content
                    const setElement = (id, value, prop = 'textContent') => {
                        const el = document.getElementById(id);
                        if (el) el[prop] = value;
                        else console.warn(`Element #${id} not found`);
                    };

                    setElement('editorPageCount', `${data.page_count} pginas`);
                    setElement('applyPageCount', data.page_count);
                    setElement('sampleIndicator', `${data.sample_index + 1} / ${totalSamples}`);
                    setElement('sampleUrl', data.url);
                    const sampleUrlEl = document.getElementById('sampleUrl');
                    if (sampleUrlEl) sampleUrlEl.title = data.url;

                    // Update markdown preview
                    // If auto_clean was applied, show that in the left panel instead of original
                    const hasAutoClean = data.auto_clean_applied === true;
                    const leftPanelMd = hasAutoClean
                        ? (data.auto_clean_content || data.markdown_original || '(vaco)')
                        : (data.markdown_original || '(vaco)');
                    const previewMd = data.markdown_preview || '(vaco)';

                    // Store raw markdown for pattern matching (use auto_clean if available)
                    window.currentRawMarkdown = leftPanelMd;

                    // Update pipeline indicator
                    const pipelineStep2 = document.getElementById('pipelineStep2');
                    if (pipelineStep2) {
                        if (hasAutoClean) {
                            pipelineStep2.style.background = '#0d6efd'; // Active blue
                            pipelineStep2.innerHTML = '<i class="bi bi-check-circle-fill"></i> Auto-clean';
                        } else {
                            pipelineStep2.style.background = '#6c757d'; // Inactive gray
                            pipelineStep2.innerHTML = '<i class="bi bi-magic"></i> Auto-clean';
                        }
                    }

                    // Update left panel label to indicate what's being shown
                    const leftPanelLabel = document.getElementById('leftPanelLabel');
                    const leftPanelSubLabel = document.getElementById('leftPanelSubLabel');
                    if (leftPanelLabel) {
                        if (hasAutoClean) {
                            leftPanelLabel.innerHTML = '<i class="bi bi-magic"></i> Entrada';
                            leftPanelLabel.className = 'fw-bold text-info';
                            if (leftPanelSubLabel) {
                                leftPanelSubLabel.textContent = '(auto-limpiado)';
                            }
                        } else {
                            leftPanelLabel.innerHTML = '<i class="bi bi-file-earmark"></i> Entrada';
                            leftPanelLabel.className = 'fw-bold text-secondary';
                            if (leftPanelSubLabel) {
                                leftPanelSubLabel.textContent = '(del crawler)';
                            }
                        }
                    }

                    // Show content in left panel as raw text (so copy-paste works for pattern matching)
                    // Use <pre> with word-wrap to show exact markdown source
                    const originalEl = document.getElementById('markdownOriginal');
                    originalEl.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; font-size: inherit;">${escapeHtml(leftPanelMd)}</pre>`;

                    // Show PREVIEW as rendered HTML (to see the cleaned result visually)
                    try {
                        setElement('markdownPreview', marked.parse(previewMd), 'innerHTML');
                    } catch (e) {
                        setElement('markdownPreview', previewMd);
                    }

                    // Helper to escape HTML for safe display
                    function escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }

                    // Update stats (show auto_clean_length if auto_clean applied)
                    const leftPanelLength = hasAutoClean && data.auto_clean_length
                        ? data.auto_clean_length
                        : data.original_length;
                    setElement('originalLength', `${leftPanelLength}`);
                    setElement('previewLength', `${data.preview_length}`);
                    setElement('reductionPct', `${data.reduction_pct}%`);

                    // Update reduction badge
                    const reductionBadge = document.getElementById('reductionBadge');
                    if (reductionBadge) {
                        reductionBadge.textContent = `-${data.reduction_pct}%`;
                    }

                    // Update patterns list
                    renderPatterns();

                    // Load available patterns from other templates
                    window.refreshAvailablePatterns();

                    // Update navigation buttons
                    prevSampleBtn.disabled = currentSampleIndex === 0;
                    nextSampleBtn.disabled = currentSampleIndex >= totalSamples - 1;

                    // Enable apply button if there are patterns
                    applyCleaningBtn.disabled = currentPatterns.length === 0;

                } catch (error) {
                    console.error('Error loading sample:', error);
                    showToast('Error cargando muestra', 'error');
                }
            }

            // Render patterns list (compact for narrow column)
            function renderPatterns() {
                if (currentPatterns.length === 0) {
                    patternsList.innerHTML = '<p class="text-muted small text-center py-2">Sin patrones</p>';
                    return;
                }

                // Helper to get badge color and label based on pattern type
                const getPatternLabel = (type) => {
                    const labels = {
                        'contains': { label: 'contiene', class: 'bg-primary' },
                        'exact': { label: 'exacto', class: 'bg-success' },
                        'line_range': { label: 'rango', class: 'bg-warning text-dark' },
                        'text_range': { label: 'rango xN', class: 'bg-warning text-dark' },
                        'prefix': { label: 'prefijo', class: 'bg-info' },
                        'regex': { label: 'regex', class: 'bg-danger' }
                    };
                    return labels[type] || { label: type, class: 'bg-secondary' };
                };

                patternsList.innerHTML = currentPatterns.map(p => {
                    const patternInfo = getPatternLabel(p.pattern_type);
                    return `
                    <div class="pattern-item p-1 border-bottom" style="font-size: 0.75rem;">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge ${patternInfo.class}" style="font-size: 0.65rem;">${patternInfo.label}</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary btn-sm px-1 py-0" onclick="window.copyPattern('${p.id}')" title="Copiar patrn">
                                    <i class="bi bi-clipboard" style="font-size: 0.7rem;"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm px-1 py-0" onclick="window.removeCleaningPattern('${p.id}')" title="Eliminar">
                                    <i class="bi bi-x" style="font-size: 0.7rem;"></i>
                                </button>
                            </div>
                        </div>
                        <pre class="pattern-value mb-0 mt-1 p-1 bg-light rounded" style="white-space: pre-wrap; word-break: break-all; max-height: 60px; overflow-y: auto; font-size: 0.65rem; user-select: all; line-height: 1.2;" data-pattern-id="${p.id}">${escapeHtml(p.value.length > 100 ? p.value.substring(0, 100) + '...' : p.value)}</pre>
                    </div>
                `}).join('');
            }

            // Copy pattern to clipboard
            window.copyPattern = function(patternId) {
                const pattern = currentPatterns.find(p => p.id === patternId);
                if (pattern) {
                    navigator.clipboard.writeText(pattern.value).then(() => {
                        showToast('Patrn copiado al portapapeles', 'success');
                    }).catch(err => {
                        console.error('Error copying:', err);
                        showToast('Error al copiar', 'error');
                    });
                }
            }

            // Add pattern
            async function addPattern() {
                const type = getSelectedPatternType();
                let value = patternValue.value.trim();

                if (!value) {
                    showToast('Introduce un valor para el patrn', 'warning');
                    return;
                }

                // For line_range and text_range, combine start and end
                if (type === 'line_range' || type === 'text_range') {
                    const endValue = patternValueEnd.value.trim();
                    if (!endValue) {
                        showToast('Introduce el texto final para el rango', 'warning');
                        return;
                    }
                    value = `${value}|||${endValue}`;
                }

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/pattern/${currentCrawl}/${currentTemplateId}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pattern_type: type,
                                value: value,
                                description: ''
                            })
                        }
                    );

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Error adding pattern');
                    }

                    showToast('Patrn aadido', 'success');
                    patternValue.value = '';
                    patternValueEnd.value = '';

                    // Reload sample to see updated preview
                    await loadTemplateSample();

                } catch (error) {
                    console.error('Error adding pattern:', error);
                    showToast(error.message, 'error');
                }
            }

            // Load available patterns from other templates
            window.refreshAvailablePatterns = async function() {
                if (!currentCrawl || !currentTemplateId) return;

                const section = document.getElementById('availablePatternsSection');
                const list = document.getElementById('availablePatternsList');

                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/available-patterns/${currentCrawl}/${currentTemplateId}`
                    );

                    if (!response.ok) return;

                    const data = await response.json();

                    if (data.available_count === 0) {
                        section.style.display = 'none';
                        return;
                    }

                    // Show section
                    section.style.display = 'block';

                    // Render available patterns as buttons
                    list.innerHTML = data.patterns.map(p => {
                        const typeLabel = {
                            'contains': 'cont',
                            'exact': 'exact',
                            'line_range': 'rango',
                            'prefix': 'pref'
                        }[p.pattern_type] || p.pattern_type;

                        const escapedValue = escapeHtml(p.preview);
                        const fullValue = escapeHtml(p.value).replace(/'/g, "\\'");
                        const fullValueEnd = p.value_end ? escapeHtml(p.value_end).replace(/'/g, "\\'") : '';

                        return `
                            <button class="btn btn-outline-info btn-sm py-0 px-1" style="font-size: 0.65rem; max-width: 150px;"
                                    onclick="window.reusePattern('${p.pattern_type}', '${fullValue}', '${fullValueEnd}')"
                                    title="${escapedValue} (${typeLabel})">
                                <span class="text-truncate d-inline-block" style="max-width: 120px;">${escapedValue}</span>
                            </button>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('Error loading available patterns:', error);
                }
            };

            // Reuse a pattern from another template
            window.reusePattern = async function(patternType, value, valueEnd) {
                if (!currentCrawl || !currentTemplateId) {
                    showToast('Selecciona primero una plantilla', 'error');
                    return;
                }

                try {
                    const body = {
                        pattern_type: patternType,
                        value: value
                    };
                    if (valueEnd) {
                        body.value_end = valueEnd;
                    }

                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/pattern/${currentCrawl}/${currentTemplateId}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        }
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Error adding pattern');
                    }

                    showToast('Patrn reutilizado', 'success');
                    await loadTemplateSample();
                    // Refresh available patterns list (the one we just used should disappear)
                    await window.refreshAvailablePatterns();

                } catch (error) {
                    console.error('Error reusing pattern:', error);
                    showToast('Error reutilizando patrn', 'error');
                }
            };

            // Remove pattern - expose globally
            window.removeCleaningPattern = async function(patternId) {
                try {
                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/pattern/${currentCrawl}/${currentTemplateId}/${patternId}`,
                        { method: 'DELETE' }
                    );

                    if (!response.ok) throw new Error('Error removing pattern');

                    showToast('Patrn eliminado', 'success');
                    await loadTemplateSample();

                } catch (error) {
                    console.error('Error removing pattern:', error);
                    showToast('Error eliminando patrn', 'error');
                }
            };

            // Preview cleaning modal
            const cleanerPreviewModal = new bootstrap.Modal(document.getElementById('cleanerPreviewModal'));
            const applyFromPreviewBtn = document.getElementById('applyFromPreviewBtn');

            applyFromPreviewBtn.addEventListener('click', async () => {
                cleanerPreviewModal.hide();
                await applyCleaning();
            });

            // Preview cleaning
            async function previewCleaning() {
                previewCleaningBtn.disabled = true;
                previewCleaningBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div> Previsualizando...';

                try {
                    // First ensure templates are analyzed (to populate cache)
                    await fetch(`${API_URL}/api/v1/dashboard/manual-cleaner/analyze/${currentCrawl}`);

                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/preview/${currentCrawl}/${currentTemplateId}`
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Error previewing');
                    }

                    const data = await response.json();

                    // Update modal with data
                    document.getElementById('previewTotalPages').textContent = data.page_count;
                    document.getElementById('previewAvgReduction').textContent = data.avg_reduction_pct + '%';
                    document.getElementById('previewPatternsCount').textContent = data.patterns_count;

                    // Build pages table
                    const tableBody = document.getElementById('previewPagesTable');
                    tableBody.innerHTML = data.pages.map(page => `
                        <tr>
                            <td><small class="text-truncate d-inline-block" style="max-width: 300px;" title="${page.url}">${page.url.replace(/^https?:\/\/[^\/]+/, '')}</small></td>
                            <td class="text-end">${(page.original_length / 1000).toFixed(1)}k</td>
                            <td class="text-end">${(page.clean_length / 1000).toFixed(1)}k</td>
                            <td class="text-end"><span class="badge ${page.reduction_pct > 10 ? 'bg-success' : 'bg-secondary'}">${page.reduction_pct}%</span></td>
                        </tr>
                    `).join('');

                    // Show modal
                    cleanerPreviewModal.show();

                    // Enable apply button
                    applyCleaningBtn.disabled = false;

                } catch (error) {
                    console.error('Error previewing:', error);
                    showToast('Error en preview: ' + error.message, 'error');
                } finally {
                    previewCleaningBtn.disabled = false;
                    previewCleaningBtn.innerHTML = '<i class="bi bi-eye"></i> Vista Previa';
                }
            }

            // Apply cleaning
            async function applyCleaning() {
                if (!confirm(`Aplicar limpieza a todas las pginas de esta plantilla?`)) {
                    return;
                }

                applyCleaningBtn.disabled = true;
                applyCleaningBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div> Aplicando...';

                try {
                    // Build request body with auto-clean options
                    const requestBody = {};

                    // Check if auto-clean is enabled
                    const enableAutoClean = document.getElementById('enableAutoClean');
                    if (enableAutoClean && enableAutoClean.checked) {
                        requestBody.auto_clean_options = {
                            extract_from_first_heading: document.getElementById('acExtractHeading')?.checked ?? true,
                            remove_footer_content: document.getElementById('acRemoveFooter')?.checked ?? true,
                            remove_nav_patterns: document.getElementById('acRemoveNav')?.checked ?? true,
                            remove_empty_lines: document.getElementById('acCleanLines')?.checked ?? true,
                            min_heading_level: 1
                        };
                    }

                    const response = await fetch(
                        `${API_URL}/api/v1/dashboard/manual-cleaner/apply/${currentCrawl}/${currentTemplateId}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        }
                    );

                    if (!response.ok) throw new Error('Error applying cleaning');

                    const data = await response.json();

                    const autoMsg = data.auto_clean_applied ? ' (+ auto-limpieza)' : '';
                    showToast(`Limpieza aplicada: ${data.pages_cleaned} pginas procesadas${autoMsg}`, 'success');

                    // Go back to templates list
                    backToTemplatesBtn.click();

                    // Reload templates to update status
                    window.selectCrawlForCleaning(currentCrawl);

                } catch (error) {
                    console.error('Error applying cleaning:', error);
                    showToast('Error aplicando limpieza', 'error');
                } finally {
                    applyCleaningBtn.disabled = false;
                    applyCleaningBtn.innerHTML = '<i class="bi bi-check-circle"></i> Aplicar a Todas';
                }
            }
        }

        // Clients functionality
        function initClients() {
            const modal = document.getElementById('newClientModal');
            const newBtn = document.getElementById('newClientBtn');
            const closeBtn = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelClient');
            const createBtn = document.getElementById('createClient');

            newBtn.addEventListener('click', () => modal.classList.add('active'));
            closeBtn.addEventListener('click', () => modal.classList.remove('active'));
            cancelBtn.addEventListener('click', () => modal.classList.remove('active'));

            createBtn.addEventListener('click', async () => {
                const name = document.getElementById('newClientName').value.trim();
                const domain = document.getElementById('newClientDomain').value.trim();

                if (!name || !domain) {
                    showToast('Completa todos los campos', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/v1/admin/clients`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, domain })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        showToast(`Cliente creado. API Key: ${data.api_key}`);
                        modal.classList.remove('active');
                        loadClients();
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Error al crear cliente', 'error');
                    }
                } catch (error) {
                    showToast('Error de conexin', 'error');
                }
            });
        }

        async function viewClientStats(clientId) {
            try {
                const response = await fetch(`${API_URL}/api/v1/admin/clients/${clientId}/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    alert(JSON.stringify(stats, null, 2));
                }
            } catch (error) {
                showToast('Error al cargar estadsticas', 'error');
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Seguro que quieres eliminar este cliente y TODOS sus datos?')) return;

            try {
                const response = await fetch(`${API_URL}/api/v1/dashboard/clients/${clientId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    showToast('Cliente eliminado correctamente');
                    loadClients();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Error al eliminar cliente', 'error');
                }
            } catch (error) {
                showToast('Error de conexin', 'error');
            }
        }

        async function calculateScores(clientId) {
            if (!confirm('Calcular PageRank y HITS para este cliente? Esto puede tardar unos segundos.')) return;

            showToast('Calculando scores...');

            try {
                const response = await fetch(`${API_URL}/api/v1/dashboard/clients/${clientId}/calculate-scores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast(`PageRank/HITS calculado: ${data.synced_to_supabase} pginas actualizadas`);
                    loadClients();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Error al calcular scores', 'error');
                }
            } catch (error) {
                showToast('Error de conexin', 'error');
            }
        }

        async function regenerateEmbeddings(clientId) {
            if (!confirm('Regenerar TODOS los embeddings? Esto puede tardar varios minutos.')) return;

            showToast('Regenerando embeddings... esto puede tardar');

            try {
                const response = await fetch(`${API_URL}/api/v1/dashboard/clients/${clientId}/regenerate-embeddings`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast(`Embeddings regenerados: ${data.updated} de ${data.total_pages} pginas`);
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Error al regenerar embeddings', 'error');
                }
            } catch (error) {
                showToast('Error de conexin', 'error');
            }
        }

        async function rotateApiKey(clientId) {
            if (!confirm('Generar una nueva API Key? La anterior dejar de funcionar.')) return;

            try {
                const response = await fetch(`${API_URL}/api/v1/dashboard/clients/${clientId}/rotate-key`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Mostrar la nueva API key de forma prominente
                    alert(`Nueva API Key (gurdala, no se mostrar otra vez):\n\n${data.new_api_key}`);
                    showToast('API Key rotada exitosamente');
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Error al rotar API key', 'error');
                }
            } catch (error) {
                showToast('Error de conexin', 'error');
            }
        }

        async function viewGraph(clientId) {
            const client = clients.find(c => c.id === clientId);
            const clientName = client ? client.name : 'Cliente';

            showToast('Cargando grafo...');

            try {
                const response = await fetch(`${API_URL}/api/v1/dashboard/graph/${clientId}?limit=1000`);

                if (response.ok) {
                    const data = await response.json();

                    if (data.nodes.length === 0) {
                        showToast('No hay datos de grafo para este cliente', 'error');
                        return;
                    }

                    // Crear modal para mostrar el grafo
                    showGraphModal(clientName, data);
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Error al cargar grafo', 'error');
                }
            } catch (error) {
                showToast('Error de conexin', 'error');
            }
        }

        function showGraphModal(clientName, graphData) {
            console.log('showGraphModal called with', graphData.nodes.length, 'nodes');

            // Crear modal dinmicamente
            const existingModal = document.getElementById('graphModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'graphModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal modal-large" style="width: 90vw; height: 80vh; display: flex; flex-direction: column;">
                    <div class="modal-header" style="flex-shrink: 0;">
                        <h5 class="modal-title"><i class="bi bi-diagram-3"></i> Grafo: ${clientName} (${graphData.total_nodes} nodos, ${graphData.total_edges} enlaces)</h5>
                        <button class="modal-close" onclick="document.getElementById('graphModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="flex: 1; padding: 0; overflow: hidden; display: flex;">
                        <div id="modalGraphContainer" style="flex: 1; min-height: 500px; background: #1a1a2e;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const container = document.getElementById('modalGraphContainer');
            console.log('Modal appended, container:', container, 'size:', container.offsetWidth, 'x', container.offsetHeight);

            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Renderizar grafo despus de que el DOM est listo
            requestAnimationFrame(() => {
                setTimeout(() => {
                    console.log('Timeout fired, calling renderModalGraph');
                    const graphContainer = document.getElementById('modalGraphContainer');
                    if (graphContainer && graphContainer.offsetWidth > 0 && graphContainer.offsetHeight > 0) {
                        renderModalGraph(graphContainer, graphData);
                    } else {
                        // Retry after another frame if container not ready
                        setTimeout(() => renderModalGraph(graphContainer, graphData), 100);
                    }
                }, 100);
            });
        }

        function renderModalGraph(container, graphData) {
            console.log('renderModalGraph called');

            if (!container) {
                console.error('Modal graph container not found');
                showToast('Error: contenedor del grafo no encontrado', 'error');
                return;
            }

            console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);

            try {
                // Crear nodos
                const nodesArray = graphData.nodes.map((n, idx) => ({
                    id: idx,
                    label: (n.label || 'Nodo ' + idx).substring(0, 25),
                    title: n.title || n.url || 'Sin ttulo',
                    color: {
                        background: '#4fc3f7',
                        border: '#0288d1',
                        highlight: { background: '#81d4fa', border: '#03a9f4' }
                    }
                }));

                // Crear mapa de URL a ndice
                const urlToIdx = {};
                graphData.nodes.forEach((n, idx) => {
                    urlToIdx[n.id] = idx;
                });

                // Crear edges
                const edgesArray = graphData.edges
                    .filter(e => e.from !== e.to && urlToIdx[e.from] !== undefined && urlToIdx[e.to] !== undefined)
                    .map(e => ({
                        from: urlToIdx[e.from],
                        to: urlToIdx[e.to]
                    }));

                console.log('Data ready:', nodesArray.length, 'nodes,', edgesArray.length, 'edges');

                const nodes = new vis.DataSet(nodesArray);
                const edges = new vis.DataSet(edgesArray);

                const options = {
                    nodes: {
                        shape: 'dot',
                        size: 20,
                        font: { color: '#ffffff', size: 12, face: 'arial' }
                    },
                    edges: {
                        color: { color: '#90a4ae', highlight: '#b0bec5' },
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                        smooth: { type: 'continuous' },
                        width: 2
                    },
                    physics: {
                        enabled: true,
                        solver: 'forceAtlas2Based',
                        forceAtlas2Based: {
                            gravitationalConstant: -100,
                            centralGravity: 0.02,
                            springLength: 150
                        },
                        stabilization: { iterations: 100 }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200,
                        navigationButtons: true,
                        keyboard: true
                    }
                };

                console.log('Creating vis.Network...');
                const network = new vis.Network(container, { nodes, edges }, options);
                console.log('vis.Network created');

                network.on('stabilizationIterationsDone', () => {
                    console.log('Graph stabilization complete');
                    network.fit();
                });

                window.graphNetwork = network;
                showToast('Grafo cargado: ' + nodesArray.length + ' nodos');
            } catch (error) {
                console.error('Error rendering modal graph:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        function renderGraph(graphData) {
            console.log('renderGraph called');
            const container = document.getElementById('graphContainer');

            if (!container) {
                console.error('graphContainer not found');
                showToast('Error: contenedor del grafo no encontrado', 'error');
                return;
            }

            // Forzar dimensiones absolutas en pxeles
            const width = Math.max(800, window.innerWidth * 0.85);
            const height = Math.max(500, window.innerHeight * 0.7);
            container.style.width = width + 'px';
            container.style.height = height + 'px';

            console.log('Container dimensions set to:', width, 'x', height);

            // Verificar que vis est disponible
            if (typeof vis === 'undefined') {
                console.error('vis is undefined');
                showToast('Error: librera vis.js no cargada', 'error');
                return;
            }

            if (!vis.Network) {
                console.error('vis.Network is undefined');
                showToast('Error: vis.Network no disponible', 'error');
                return;
            }

            console.log('vis.js available, vis.DataSet:', typeof vis.DataSet, 'vis.Network:', typeof vis.Network);

            try {
                // Crear nodos simples
                const nodesArray = graphData.nodes.map((n, idx) => ({
                    id: idx,
                    label: (n.label || 'Nodo ' + idx).substring(0, 25),
                    title: n.title || n.url || 'Sin ttulo',
                    color: {
                        background: '#4a90d9',
                        border: '#2d5a8a',
                        highlight: { background: '#6ab0f9', border: '#3d7abd' }
                    }
                }));

                // Crear mapa de URL a ndice
                const urlToIdx = {};
                graphData.nodes.forEach((n, idx) => {
                    urlToIdx[n.id] = idx;
                });

                // Crear edges usando ndices
                const edgesArray = graphData.edges
                    .filter(e => e.from !== e.to && urlToIdx[e.from] !== undefined && urlToIdx[e.to] !== undefined)
                    .map(e => ({
                        from: urlToIdx[e.from],
                        to: urlToIdx[e.to]
                    }));

                console.log('Data ready:', nodesArray.length, 'nodes,', edgesArray.length, 'edges');

                // Crear DataSets
                const nodes = new vis.DataSet(nodesArray);
                const edges = new vis.DataSet(edgesArray);
                console.log('DataSets created');

                const data = { nodes: nodes, edges: edges };

                const options = {
                    nodes: {
                        shape: 'dot',
                        size: 20,
                        color: {
                            background: '#4fc3f7',
                            border: '#0288d1',
                            highlight: {
                                background: '#81d4fa',
                                border: '#03a9f4'
                            }
                        },
                        font: { color: '#ffffff', size: 12, face: 'arial' }
                    },
                    edges: {
                        color: { color: '#90a4ae', highlight: '#b0bec5' },
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                        smooth: { type: 'continuous' },
                        width: 2
                    },
                    physics: {
                        enabled: true,
                        solver: 'forceAtlas2Based',
                        forceAtlas2Based: {
                            gravitationalConstant: -100,
                            centralGravity: 0.02,
                            springLength: 150
                        },
                        stabilization: { iterations: 100 }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200,
                        navigationButtons: true,
                        keyboard: true
                    }
                };

                console.log('Creating vis.Network on container...');
                const network = new vis.Network(container, data, options);
                console.log('vis.Network instance created:', network);

                // Fit immediately and after stabilization
                setTimeout(() => {
                    network.fit();
                    console.log('Initial fit done');
                }, 100);

                network.on('stabilizationIterationsDone', function() {
                    console.log('Graph stabilization complete');
                    network.fit();
                });

                network.on('click', function(params) {
                    console.log('Graph clicked:', params);
                });

                // Store reference for debugging
                window.graphNetwork = network;

                showToast('Grafo cargado: ' + nodesArray.length + ' nodos');
            } catch (error) {
                console.error('Error rendering graph:', error);
                console.error('Error stack:', error.stack);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Settings functionality
        function initSettings() {
            const apiUrlInput = document.getElementById('apiUrl');
            apiUrlInput.value = API_URL;

            document.getElementById('testConnections').addEventListener('click', async () => {
                try {
                    const response = await fetch(`${apiUrlInput.value}/api/v1/health`);
                    if (response.ok) {
                        showToast('Conexiones exitosas');
                    } else {
                        showToast('Error en la conexin', 'error');
                    }
                } catch (error) {
                    showToast('No se puede conectar a la API', 'error');
                }
            });

            document.getElementById('saveSettings').addEventListener('click', () => {
                localStorage.setItem('apiUrl', apiUrlInput.value);
                showToast('Configuracin guardada');
            });
        }

        // Interlinking functionality
        function initInterlinking() {
            const clientSelect = document.getElementById('interlinkingClientSelect');
            const urlInput = document.getElementById('interlinkingUrl');
            const simSlider = document.getElementById('interlinkingSim');
            const simValue = document.getElementById('interlinkingSimValue');
            const getBtn = document.getElementById('getInterlinkingSuggestions');
            const suggestionsDiv = document.getElementById('interlinkingSuggestions');
            const pageInfoDiv = document.getElementById('interlinkingPageInfo');
            const backlinksDiv = document.getElementById('interlinkingBacklinks');
            const outlinksDiv = document.getElementById('interlinkingOutlinks');

            // Update client select when clients change
            function updateInterlinkingClientSelect() {
                clientSelect.innerHTML = clients.length
                    ? clients.map(c => `<option value="${c.id}">${c.name} (${c.domain})</option>`).join('')
                    : '<option value="">No hay clientes</option>';
            }

            // Load pages for autocomplete
            async function loadPagesForAutocomplete() {
                const clientId = clientSelect.value;
                if (!clientId) return;

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/pages?client_id=${clientId}&limit=200`);
                    if (response.ok) {
                        const data = await response.json();
                        const datalist = document.getElementById('pagesList');
                        datalist.innerHTML = data.pages.map(p =>
                            `<option value="${p.url}">${p.title || p.url}</option>`
                        ).join('');
                    }
                } catch (error) {
                    console.error('Error loading pages:', error);
                }
            }

            // Update slider value display
            simSlider.addEventListener('input', () => {
                simValue.textContent = simSlider.value;
            });

            // Load pages when client changes
            clientSelect.addEventListener('change', loadPagesForAutocomplete);

            // Initial load: if clients already loaded, update immediately
            if (clients && clients.length > 0) {
                updateInterlinkingClientSelect();
                loadPagesForAutocomplete();
            }

            // Also update when clients change (using event delegation or direct call)
            const originalLoadClients = loadClients;
            loadClients = async function() {
                await originalLoadClients();
                updateInterlinkingClientSelect();
                loadPagesForAutocomplete();
            };

            // Get suggestions
            getBtn.addEventListener('click', async () => {
                const clientId = clientSelect.value;
                const url = urlInput.value.trim();

                if (!clientId) {
                    showToast('Selecciona un cliente', 'error');
                    return;
                }
                if (!url) {
                    showToast('Ingresa una URL', 'error');
                    return;
                }

                suggestionsDiv.innerHTML = '<div class="spinner"></div>';
                backlinksDiv.innerHTML = '<p class="text-muted">Cargando...</p>';
                outlinksDiv.innerHTML = '<p class="text-muted">Cargando...</p>';

                try {
                    // Get interlinking suggestions
                    const suggestionsResponse = await fetch(`${API_URL}/api/v1/dashboard/interlinking`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: clientId,
                            url: url,
                            min_similarity: parseFloat(simSlider.value),
                            limit: parseInt(document.getElementById('interlinkingLimit').value)
                        })
                    });

                    // Get related pages (backlinks/outlinks)
                    const relatedResponse = await fetch(`${API_URL}/api/v1/dashboard/related`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: clientId,
                            url: url
                        })
                    });

                    if (suggestionsResponse.ok) {
                        const data = await suggestionsResponse.json();

                        // Update page info
                        pageInfoDiv.innerHTML = `
                            <p><strong>URL:</strong> <a href="${url}" target="_blank">${url}</a></p>
                            <p><strong>Ttulo:</strong> ${data.source_title || 'Sin ttulo'}</p>
                            <p><strong>Enlaces existentes:</strong> ${data.already_linked}</p>
                        `;

                        // Render suggestions
                        if (data.suggestions && data.suggestions.length > 0) {
                            suggestionsDiv.innerHTML = data.suggestions.map((s, idx) => `
                                <div class="suggestion-item" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <strong>${escapeHtml(s.title || 'Sin ttulo')}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                <a href="${s.url}" target="_blank">${escapeHtml(s.url)}</a>
                                            </div>
                                            ${s.content_preview ? `<p style="font-size: 0.85rem; margin-top: 0.5rem;">${escapeHtml(s.content_preview)}</p>` : ''}
                                        </div>
                                        <div style="text-align: right; min-width: 100px;">
                                            <span class="badge" style="background: var(--primary-color); color: #fff;">${(s.similarity * 100).toFixed(1)}%</span>
                                            <div style="font-size: 0.75rem; margin-top: 0.25rem;">PageRank: ${s.pagerank.toFixed(4)}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            suggestionsDiv.innerHTML = '<p class="text-muted text-center">No se encontraron sugerencias. Prueba reduciendo la similitud mnima.</p>';
                        }
                    } else {
                        const error = await suggestionsResponse.json();
                        suggestionsDiv.innerHTML = `<p class="text-danger">${error.detail || 'Error al obtener sugerencias'}</p>`;
                    }

                    // Render backlinks/outlinks
                    if (relatedResponse.ok) {
                        const related = await relatedResponse.json();

                        // Backlinks
                        if (related.backlinks && related.backlinks.length > 0) {
                            backlinksDiv.innerHTML = `
                                <p class="text-muted" style="font-size: 0.85rem;">${related.total_backlinks} enlaces entrantes</p>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${related.backlinks.slice(0, 10).map(b => `
                                        <li style="padding: 0.25rem 0; border-bottom: 1px solid var(--border-color);">
                                            <a href="${b.url}" target="_blank" style="font-size: 0.85rem;">${escapeHtml(b.title || b.url)}</a>
                                        </li>
                                    `).join('')}
                                </ul>
                            `;
                        } else {
                            backlinksDiv.innerHTML = '<p class="text-muted">No hay backlinks</p>';
                        }

                        // Outlinks
                        if (related.outlinks && related.outlinks.length > 0) {
                            outlinksDiv.innerHTML = `
                                <p class="text-muted" style="font-size: 0.85rem;">${related.total_outlinks} enlaces salientes</p>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${related.outlinks.slice(0, 10).map(o => `
                                        <li style="padding: 0.25rem 0; border-bottom: 1px solid var(--border-color);">
                                            <a href="${o.url}" target="_blank" style="font-size: 0.85rem;">${escapeHtml(o.title || o.url)}</a>
                                        </li>
                                    `).join('')}
                                </ul>
                            `;
                        } else {
                            outlinksDiv.innerHTML = '<p class="text-muted">No hay enlaces salientes</p>';
                        }
                    }

                } catch (error) {
                    suggestionsDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
                }
            });
        }

        // Graph Explorer functionality
        // Funcin auxiliar para validar URLs
        function isValidUrl(str) {
            try {
                new URL(str);
                return true;
            } catch {
                return false;
            }
        }

        function initGraphExplorer() {
            const nodeSearchInput = document.getElementById('nodeSearch');
            const findNodeBtn = document.getElementById('findNode');
            const pathFromInput = document.getElementById('pathFrom');
            const pathToInput = document.getElementById('pathTo');
            const findPathBtn = document.getElementById('findPath');
            const nodeInfoDiv = document.getElementById('nodeInfo');
            const graphVizContainer = document.getElementById('graphViz');

            // Store network instance for zoom controls
            let explorerNetwork = null;

            // Zoom controls
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const resetViewBtn = document.getElementById('resetView');

            zoomInBtn.addEventListener('click', () => {
                if (explorerNetwork) {
                    const scale = explorerNetwork.getScale();
                    explorerNetwork.moveTo({ scale: scale * 1.3 });
                } else {
                    showToast('Busca un nodo primero para ver el grafo', 'error');
                }
            });

            zoomOutBtn.addEventListener('click', () => {
                if (explorerNetwork) {
                    const scale = explorerNetwork.getScale();
                    explorerNetwork.moveTo({ scale: scale / 1.3 });
                } else {
                    showToast('Busca un nodo primero para ver el grafo', 'error');
                }
            });

            resetViewBtn.addEventListener('click', () => {
                if (explorerNetwork) {
                    explorerNetwork.fit();
                } else {
                    showToast('Busca un nodo primero para ver el grafo', 'error');
                }
            });

            // Function to render graph in the explorer
            function renderExplorerGraph(centerUrl, relatedData) {
                if (!graphVizContainer) {
                    console.error('graphViz container not found');
                    return;
                }

                // Build nodes array - center node + related pages
                const nodesArray = [];
                const urlToIdx = {};

                // Add center node
                nodesArray.push({
                    id: 0,
                    label: centerUrl.replace(/https?:\/\/[^\/]+/, '').substring(0, 30) || '/',
                    title: centerUrl,
                    color: {
                        background: '#f44336',
                        border: '#c62828',
                        highlight: { background: '#ef5350', border: '#d32f2f' }
                    },
                    size: 30
                });
                urlToIdx[centerUrl] = 0;

                // Add related nodes
                relatedData.related.forEach((r, idx) => {
                    if (r.url !== centerUrl) {
                        const nodeIdx = nodesArray.length;
                        nodesArray.push({
                            id: nodeIdx,
                            label: (r.title || r.url.replace(/https?:\/\/[^\/]+/, '')).substring(0, 25),
                            title: r.url + '\nPageRank: ' + r.pagerank.toFixed(4),
                            color: {
                                background: '#4fc3f7',
                                border: '#0288d1',
                                highlight: { background: '#81d4fa', border: '#03a9f4' }
                            },
                            size: 15 + (r.pagerank * 15)
                        });
                        urlToIdx[r.url] = nodeIdx;
                    }
                });

                // Build edges - connect center to all related
                const edgesArray = [];
                relatedData.related.forEach(r => {
                    if (r.url !== centerUrl && urlToIdx[r.url] !== undefined) {
                        edgesArray.push({
                            from: 0,
                            to: urlToIdx[r.url]
                        });
                    }
                });

                // Create vis.js network
                const nodes = new vis.DataSet(nodesArray);
                const edges = new vis.DataSet(edgesArray);

                const options = {
                    nodes: {
                        shape: 'dot',
                        font: { color: '#ffffff', size: 11, face: 'arial' }
                    },
                    edges: {
                        color: { color: '#90a4ae', highlight: '#b0bec5' },
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                        smooth: { type: 'continuous' },
                        width: 1.5
                    },
                    physics: {
                        enabled: true,
                        solver: 'forceAtlas2Based',
                        forceAtlas2Based: {
                            gravitationalConstant: -80,
                            centralGravity: 0.015,
                            springLength: 120
                        },
                        stabilization: { iterations: 80 }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200,
                        zoomView: true,
                        dragView: true
                    }
                };

                // Destroy previous network if exists
                if (explorerNetwork) {
                    explorerNetwork.destroy();
                }

                explorerNetwork = new vis.Network(graphVizContainer, { nodes, edges }, options);

                explorerNetwork.on('stabilizationIterationsDone', () => {
                    explorerNetwork.fit();
                });

                explorerNetwork.on('click', (params) => {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const node = nodesArray.find(n => n.id === nodeId);
                        if (node && node.title) {
                            const url = node.title.split('\n')[0];
                            nodeSearchInput.value = url;
                        }
                    }
                });

                showToast(`Grafo cargado: ${nodesArray.length} nodos`);
            }

            // Find related pages when searching for a node
            findNodeBtn.addEventListener('click', async () => {
                const url = nodeSearchInput.value.trim();
                const clientId = document.getElementById('chatClientSelect').value;

                if (!url) {
                    showToast('Ingresa una URL para buscar', 'error');
                    return;
                }
                if (!isValidUrl(url)) {
                    showToast('Ingresa una URL vlida (ej: https://ejemplo.com/pagina)', 'error');
                    return;
                }
                if (!clientId) {
                    showToast('Selecciona un cliente primero', 'error');
                    return;
                }

                nodeInfoDiv.innerHTML = '<div class="spinner"></div>';

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/related`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: clientId,
                            url: url,
                            hops: 2,
                            limit: 20
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Render graph visualization
                        renderExplorerGraph(url, data);

                        nodeInfoDiv.innerHTML = `
                            <h6><i class="bi bi-link"></i> URL: <a href="${url}" target="_blank">${url}</a></h6>
                            <hr>
                            <p><strong>Enlaces entrantes:</strong> ${data.total_backlinks}</p>
                            <p><strong>Enlaces salientes:</strong> ${data.total_outlinks}</p>
                            <p><strong>Pginas relacionadas:</strong> ${data.total_related}</p>
                            <hr>
                            <h6>Pginas relacionadas (por PageRank):</h6>
                            <ul style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;">
                                ${data.related.slice(0, 10).map(r => `
                                    <li style="padding: 0.25rem 0; font-size: 0.85rem;">
                                        <a href="${r.url}" target="_blank">${escapeHtml(r.title || r.url)}</a>
                                        <span class="badge" style="background: var(--secondary-color); color: #fff; font-size: 0.7rem;">${r.pagerank.toFixed(4)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    } else {
                        const error = await response.json();
                        nodeInfoDiv.innerHTML = `<p class="text-danger">${error.detail || 'Pgina no encontrada'}</p>`;
                    }
                } catch (error) {
                    nodeInfoDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
                }
            });

            // Find path between two pages
            findPathBtn.addEventListener('click', async () => {
                const sourceUrl = pathFromInput.value.trim();
                const targetUrl = pathToInput.value.trim();
                const clientId = document.getElementById('chatClientSelect').value;

                if (!sourceUrl || !targetUrl) {
                    showToast('Ingresa ambas URLs', 'error');
                    return;
                }
                if (!isValidUrl(sourceUrl)) {
                    showToast('URL de origen invlida', 'error');
                    return;
                }
                if (!isValidUrl(targetUrl)) {
                    showToast('URL de destino invlida', 'error');
                    return;
                }
                if (!clientId) {
                    showToast('Selecciona un cliente primero', 'error');
                    return;
                }

                nodeInfoDiv.innerHTML = '<div class="spinner"></div>';

                try {
                    const response = await fetch(`${API_URL}/api/v1/dashboard/path`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: clientId,
                            source_url: sourceUrl,
                            target_url: targetUrl
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (data.found && data.path) {
                            nodeInfoDiv.innerHTML = `
                                <h6><i class="bi bi-signpost-split"></i> Camino encontrado</h6>
                                <p><strong>Longitud:</strong> ${data.path_length} saltos</p>
                                <hr>
                                <h6>Ruta:</h6>
                                <ol style="padding-left: 1.25rem;">
                                    ${data.path.map((url, idx) => `
                                        <li style="padding: 0.25rem 0; font-size: 0.85rem;">
                                            <a href="${url}" target="_blank">${escapeHtml(url)}</a>
                                            ${idx < data.path.length - 1 ? '<i class="bi bi-arrow-down" style="display: block; text-align: center; color: var(--text-secondary);"></i>' : ''}
                                        </li>
                                    `).join('')}
                                </ol>
                            `;
                        } else {
                            nodeInfoDiv.innerHTML = `
                                <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> No se encontr ningn camino entre las dos pginas.</p>
                                <p class="text-muted" style="font-size: 0.85rem;">Las pginas pueden no estar conectadas directamente.</p>
                            `;
                        }
                    } else {
                        const error = await response.json();
                        nodeInfoDiv.innerHTML = `<p class="text-danger">${error.detail || 'Error al buscar camino'}</p>`;
                    }
                } catch (error) {
                    nodeInfoDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
                }
            });
        }

    </script>
</body>
</html>
