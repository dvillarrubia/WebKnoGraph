# WebKnoGraph Graph-RAG Docker Compose
# Adds the RAG service to your existing Supabase + Neo4j setup

version: '3.8'

services:
  # ==========================================================================
  # GRAPH-RAG API SERVICE
  # ==========================================================================
  graph-rag-api:
    build:
      context: .
      dockerfile: graph_rag/Dockerfile
    container_name: graph-rag-api
    ports:
      - "8080:8080"
    environment:
      # App
      - DEBUG=false

      # Supabase (adjust to your existing setup)
      - SUPABASE_URL=http://seo-supabase-api:3000
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_DB_HOST=seo-supabase-db
      - SUPABASE_DB_PORT=5432
      - SUPABASE_DB_NAME=postgres
      - SUPABASE_DB_USER=postgres
      - SUPABASE_DB_PASSWORD=${SUPABASE_DB_PASSWORD}

      # Neo4j (your existing container)
      - NEO4J_URI=bolt://seo-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=gpt-4o

      # Embeddings
      - EMBEDDING_MODEL_NAME=intfloat/multilingual-e5-large
      - EMBEDDING_DIMENSION=1024

      # RAG Settings
      - RAG_TOP_K_VECTORS=10
      - RAG_GRAPH_HOPS=2
      - RAG_MAX_CONTEXT_PAGES=15
    volumes:
      # Mount data folder for migrations
      - ./data:/app/data:ro
      # Cache for HuggingFace models
      - huggingface_cache:/home/appuser/.cache/huggingface
    depends_on:
      - seo-supabase-db
      - seo-neo4j
    networks:
      - webknograph-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Model loading takes time

  # ==========================================================================
  # YOUR EXISTING SERVICES (reference only - already running)
  # ==========================================================================
  # These are already defined in your existing docker-compose
  # Just showing them here for network reference

  seo-supabase-db:
    image: supabase/postgres:15.8.1.060
    container_name: seo-supabase-db
    # ... your existing config
    networks:
      - webknograph-network

  seo-supabase-api:
    image: postgrest/postgrest:v12.2.12
    container_name: seo-supabase-api
    # ... your existing config
    networks:
      - webknograph-network

  seo-neo4j:
    image: neo4j:5.20-community
    container_name: seo-neo4j
    # ... your existing config
    networks:
      - webknograph-network

volumes:
  huggingface_cache:
    name: graph-rag-hf-cache

networks:
  webknograph-network:
    name: webknograph-network
    external: true  # Use your existing network
